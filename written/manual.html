
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Manual &#8212; psweep</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'written/manual';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Reference" href="../generated/api/index.html" />
    <link rel="prev" title="&lt;no title&gt;" href="../root.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../root.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/psweep-logo.png" class="logo__image only-light" alt="psweep - Home"/>
    <img src="../_static/psweep-logo.png" class="logo__image only-dark pst-js-only" alt="psweep - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../root.html">
                    <no title>
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Manual</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../generated/api/index.html">API Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../generated/api/__sphinx_autodoc_module__psweep.cli.html">cli</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.cli.check_calc_dir.html">psweep.cli.check_calc_dir</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../generated/api/__sphinx_autodoc_module__psweep.psweep.html">psweep</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.FileTemplate.html">psweep.psweep.FileTemplate</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.GIT_ADD_ALL.html">psweep.psweep.GIT_ADD_ALL</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.Machine.html">psweep.psweep.Machine</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.PANDAS_DEFAULT_ORIENT.html">psweep.psweep.PANDAS_DEFAULT_ORIENT</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.PANDAS_TIME_UNIT.html">psweep.psweep.PANDAS_TIME_UNIT</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.PSET_HASH_ALG.html">psweep.psweep.PSET_HASH_ALG</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.PsweepHashError.html">psweep.psweep.PsweepHashError</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.capture_logs_wrapper.html">psweep.psweep.capture_logs_wrapper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.check_calc_dir.html">psweep.psweep.check_calc_dir</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.df_filter_conds.html">psweep.psweep.df_filter_conds</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.df_print.html">psweep.psweep.df_print</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.df_read.html">psweep.psweep.df_read</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.df_to_json.html">psweep.psweep.df_to_json</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.df_write.html">psweep.psweep.df_write</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.file_read.html">psweep.psweep.file_read</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.file_write.html">psweep.psweep.file_write</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.filter_params_dup_hash.html">psweep.psweep.filter_params_dup_hash</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.filter_params_unique.html">psweep.psweep.filter_params_unique</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.flatten.html">psweep.psweep.flatten</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.fullpath.html">psweep.psweep.fullpath</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.gather_calc_templates.html">psweep.psweep.gather_calc_templates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.gather_machines.html">psweep.psweep.gather_machines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.get_many_uuids.html">psweep.psweep.get_many_uuids</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.get_uuid.html">psweep.psweep.get_uuid</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.git_clean.html">psweep.psweep.git_clean</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.git_enter.html">psweep.psweep.git_enter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.git_exit.html">psweep.psweep.git_exit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.in_git_repo.html">psweep.psweep.in_git_repo</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.intspace.html">psweep.psweep.intspace</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.is_seq.html">psweep.psweep.is_seq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.itr.html">psweep.psweep.itr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.itr2params.html">psweep.psweep.itr2params</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.logspace.html">psweep.psweep.logspace</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.makedirs.html">psweep.psweep.makedirs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.merge_dicts.html">psweep.psweep.merge_dicts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.pgrid.html">psweep.psweep.pgrid</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.pickle_read.html">psweep.psweep.pickle_read</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.pickle_write.html">psweep.psweep.pickle_write</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.plist.html">psweep.psweep.plist</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.prep_batch.html">psweep.psweep.prep_batch</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.pset_hash.html">psweep.psweep.pset_hash</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.run.html">psweep.psweep.run</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.stargrid.html">psweep.psweep.stargrid</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.system.html">psweep.psweep.system</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/api/psweep.psweep.worker_wrapper.html">psweep.psweep.worker_wrapper</a></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/elcorto/psweep" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/written/manual.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Manual</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-started">Getting started</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#concepts">Concepts</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#naming-of-database-fields">Naming of database fields</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-parameter-grids">Building parameter grids</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-define-default-params">How to define default params</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gotchas">Gotchas</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#pgrid"><code class="docutils literal notranslate"><span class="pre">pgrid</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#zip"><code class="docutils literal notranslate"><span class="pre">zip</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-database">The database</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#special-database-fields-and-repeated-runs">Special database fields and repeated runs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#filter-by-pset-hashes">Filter by <code class="docutils literal notranslate"><span class="pre">pset</span></code> hashes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#more-details-on-naming-database-fields">More details on naming database fields</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#best-practices">Best practices</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#save-data-on-disk-use-uuids">Save data on disk, use UUIDs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#post-processing">Post-processing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iterative-extension-of-a-parameter-study">Iterative extension of a parameter study</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-git">Use git</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-handle-large-files-when-using-git">How to handle large files when using git</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#simulate-dry-run-look-before-you-leap">Simulate / Dry-Run: look before you leap</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-give-runs-names-for-easy-post-processing">Advanced: Give runs names for easy post-processing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-handle-failing-workloads">How to handle failing workloads</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#text-logging-per-pset">Text logging per <code class="docutils literal notranslate"><span class="pre">pset</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-on-hpc-compute-infrastructure">Running on (HPC) compute infrastructure</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dask"><code class="docutils literal notranslate"><span class="pre">dask</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#api">API</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hpc-machine-example">HPC machine example</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#access-to-the-dask-dashboard">Access to the <code class="docutils literal notranslate"><span class="pre">dask</span></code> dashboard</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#jupyter">Jupyter</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-request-gpus">How to request GPUs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#pros-and-cons">Pros and Cons</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#templates">Templates</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#workflow-summary">Workflow summary</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#templates-layout-and-written-files">Templates layout and written files</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#calc-templates">calc templates</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#machine-templates">machine templates</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#git-support">git support</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#s-template-pro-con">Pros and Cons</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#special-topics">Special topics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-migrate-a-normal-git-repo-to-git-lfs">How to migrate a normal <code class="docutils literal notranslate"><span class="pre">git</span></code> repo to <code class="docutils literal notranslate"><span class="pre">git-lfs</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#scope-and-related-projects">Scope and related projects</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-task-dependencies">Handling task dependencies</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="manual">
<h1>Manual<a class="headerlink" href="#manual" title="Link to this heading">#</a></h1>
<p>This package helps you to set up and run parameter studies.</p>
<p>Mostly, you’ll start with a script and a for-loop and ask “why do I
need a package for that”? Well, soon you’ll want housekeeping tools
and a database for your runs and results. This package exists because
sooner or later, everyone doing parameter scans arrives at roughly the
same workflow and tools.</p>
<p>This package deals with commonly encountered boilerplate tasks:</p>
<ul class="simple">
<li><p>write a database of parameters and results automatically</p></li>
<li><p>make a backup of the database and all results when you repeat or
extend the study</p></li>
<li><p>append new rows to the database when extending the study</p></li>
<li><p>simulate a parameter scan</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">git</span></code> support to track progress of your work and recover from mistakes</p></li>
<li><p>optional: don’t repeat already performed calculations based on parameter set
hashes</p></li>
<li><p>support for managing batch runs, e.g. on remote HPC infrastructure, using
either <a class="reference external" href="https://distributed.dask.org"><code class="docutils literal notranslate"><span class="pre">dask.distributed</span></code></a> or a template file workflow</p></li>
</ul>
<p>Otherwise, the main goal is to not constrain your flexibility by
building a complicated framework – we provide only very basic building
blocks. All data structures are really simple (dicts), as are the
provided functions. The database is a normal <code class="docutils literal notranslate"><span class="pre">pandas</span></code> DataFrame.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We assume that you run experiments on a local machine (laptop, workstation).
See the <a class="reference internal" href="#s-distributed"><span class="std std-ref">section on distributed computing</span></a> for how you can scale
out to more advanced compute infrastructure.</p>
</div>
<section id="getting-started">
<h2>Getting started<a class="headerlink" href="#getting-started" title="Link to this heading">#</a></h2>
<p>A simple example: Loop over two parameters <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> in a nested loop (grid),
calculate and store the result of a calculation for each parameter combination.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">random</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">psweep</span> <span class="k">as</span> <span class="nn">ps</span>


<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">pset</span><span class="p">):</span>
<span class="gp">... </span>   <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result_&quot;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="n">pset</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">pset</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]}</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">plist</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">plist</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">88</span><span class="p">,</span><span class="mi">99</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">params</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">pgrid</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">pgrid()</span></code> produces a list <code class="docutils literal notranslate"><span class="pre">params</span></code> of parameter sets (dicts <code class="docutils literal notranslate"><span class="pre">{'a':</span> <span class="pre">...,</span> <span class="pre">'b':</span> <span class="pre">...}</span></code>) to loop over:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">88</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">99</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">88</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">99</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">88</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">99</span><span class="p">}]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">run()</span></code> returns a database of results (<code class="docutils literal notranslate"><span class="pre">pandas</span></code> DataFrame <code class="docutils literal notranslate"><span class="pre">df</span></code>) and saves a
pickled file <code class="docutils literal notranslate"><span class="pre">calc/database.pk</span></code> by default:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.max_columns&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="go">   a   b                                _pset_hash  \</span>
<span class="go">0  1  88  2580bf27aca152e5427389214758e61ea0e544e0</span>
<span class="go">1  1  99  f2f17559c39b416483251f097ac895945641ea3a</span>
<span class="go">2  2  88  010552c86c69e723feafb1f2fdd5b7d7f7e46e32</span>
<span class="go">3  2  99  b57c5feac0608a43a65518f01da5aaf20a493535</span>
<span class="go">4  3  88  719b2a864450534f5b683a228de018bc71f4cf2d</span>
<span class="go">5  3  99  54baeefd998f4d8a8c9524c50aa0d88407cabb46</span>

<span class="go">                                _run_id                              _pset_id  \</span>
<span class="go">0  ab95c9a9-05ba-4619-b060-d3a81feeee40  d47ae513-9d70-4844-87f7-f821c9ac124b</span>
<span class="go">1  ab95c9a9-05ba-4619-b060-d3a81feeee40  6cd79932-4dc2-4e16-b98a-dcc17c188796</span>
<span class="go">2  ab95c9a9-05ba-4619-b060-d3a81feeee40  b1420236-86cb-4c37-8a07-ba625ee90c4f</span>
<span class="go">3  ab95c9a9-05ba-4619-b060-d3a81feeee40  5d0165d8-2099-4ad3-92ac-d1d6b08d7125</span>
<span class="go">4  ab95c9a9-05ba-4619-b060-d3a81feeee40  19500d3e-3b37-4815-8cd9-d0c3405269a3</span>
<span class="go">5  ab95c9a9-05ba-4619-b060-d3a81feeee40  8f3c8e8c-77a3-42c1-9ab1-7e6a67eb8845</span>

<span class="go">  _calc_dir                     _time_utc  _pset_seq  _run_seq _exec_host  \</span>
<span class="go">0      calc 2023-01-20 19:54:09.541669130          0         0    deskbot</span>
<span class="go">1      calc 2023-01-20 19:54:09.543383598          1         0    deskbot</span>
<span class="go">2      calc 2023-01-20 19:54:09.544652700          2         0    deskbot</span>
<span class="go">3      calc 2023-01-20 19:54:09.545840979          3         0    deskbot</span>
<span class="go">4      calc 2023-01-20 19:54:09.546977043          4         0    deskbot</span>
<span class="go">5      calc 2023-01-20 19:54:09.548082113          5         0    deskbot</span>

<span class="go">      result_  _pset_runtime</span>
<span class="go">0    3.629665       0.000004</span>
<span class="go">1   59.093600       0.000002</span>
<span class="go">2   84.056801       0.000002</span>
<span class="go">3   79.200365       0.000002</span>
<span class="go">4  240.718717       0.000002</span>
<span class="go">5   37.220296       0.000002</span>
</pre></div>
</div>
<p>You see the columns <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code>, the column <code class="docutils literal notranslate"><span class="pre">result_</span></code> (returned by
<code class="docutils literal notranslate"><span class="pre">func</span></code>) and a number of reserved fields for book-keeping such as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_run_id</span>
<span class="n">_pset_id</span>
<span class="n">_run_seq</span>
<span class="n">_pset_seq</span>
<span class="n">_pset_hash</span>
<span class="n">_pset_runtime</span>
<span class="n">_calc_dir</span>
<span class="n">_time_utc</span>
<span class="n">_exec_host</span>
</pre></div>
</div>
<p>Observe that one call <code class="docutils literal notranslate"><span class="pre">ps.run(func,</span> <span class="pre">params)</span></code> creates one <code class="docutils literal notranslate"><span class="pre">_run_id</span></code> – a
UUID identifying this run, where by “run” we mean one loop over all parameter
combinations. Inside that, each call <code class="docutils literal notranslate"><span class="pre">func(pset)</span></code> creates a UUID <code class="docutils literal notranslate"><span class="pre">_pset_id</span></code> and
a new row in the DataFrame (the database). In addition we also add sequential
integer IDs <code class="docutils literal notranslate"><span class="pre">_run_seq</span></code> and <code class="docutils literal notranslate"><span class="pre">_pset_seq</span></code> for convenience, as well as an
additional hash <code class="docutils literal notranslate"><span class="pre">_pset_hash</span></code> over the input dict (<code class="docutils literal notranslate"><span class="pre">pset</span></code> in the example) to
<code class="docutils literal notranslate"><span class="pre">func()</span></code>. <code class="docutils literal notranslate"><span class="pre">_pset_runtime</span></code> is the time of one <code class="docutils literal notranslate"><span class="pre">func()</span></code> call. <code class="docutils literal notranslate"><span class="pre">_pset_seq</span></code> is the
same as the integer index <code class="docutils literal notranslate"><span class="pre">df.index</span></code>. Hashes are calculated using the excellent
<a class="reference external" href="https://joblib.readthedocs.io">joblib</a> package.</p>
</section>
<section id="concepts">
<h2>Concepts<a class="headerlink" href="#concepts" title="Link to this heading">#</a></h2>
<p>The basic data structure for a param study is a list of “parameter sets” or
short “<code class="docutils literal notranslate"><span class="pre">pset</span></code>s”, each of which is a dict.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">88</span><span class="p">},</span>  <span class="c1"># pset 1</span>
          <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">99</span><span class="p">},</span>  <span class="c1"># pset 2</span>
          <span class="o">...</span>                 <span class="c1"># ...</span>
         <span class="p">]</span>
</pre></div>
</div>
<p>Each pset contains values of parameters which are varied during the parameter
study.</p>
<p>You need to define a callback function <code class="docutils literal notranslate"><span class="pre">func</span></code>, which takes exactly one
pset such as:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">88</span><span class="p">}</span>
</pre></div>
</div>
<p>and runs the workload for that pset. <code class="docutils literal notranslate"><span class="pre">func</span></code> must return a
dict, for example:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;result_&#39;</span><span class="p">:</span> <span class="mf">1.234</span><span class="p">}</span>
</pre></div>
</div>
<p>or an updated ‘pset’:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">88</span><span class="p">,</span> <span class="s1">&#39;result_&#39;</span><span class="p">:</span> <span class="mf">1.234</span><span class="p">}</span>
</pre></div>
</div>
<p>We always merge (<code class="docutils literal notranslate"><span class="pre">dict.update()</span></code>) the result of <code class="docutils literal notranslate"><span class="pre">func</span></code> with the pset, which gives
you flexibility in what to return from <code class="docutils literal notranslate"><span class="pre">func</span></code>. In particular, you are free to
also return an empty dict if you record results in another way (see the
<code class="docutils literal notranslate"><span class="pre">save_data_on_disk</span></code> example later).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">pset</span></code>s form the rows of a <code class="docutils literal notranslate"><span class="pre">pandas</span></code> DataFrame, which we use to store the
pset and the result from each <code class="docutils literal notranslate"><span class="pre">func(pset)</span></code>.</p>
<p>The idea is now to run <code class="docutils literal notranslate"><span class="pre">func</span></code> in a loop over all <code class="docutils literal notranslate"><span class="pre">pset</span></code>s in <code class="docutils literal notranslate"><span class="pre">params</span></code>. You do this
using the <code class="docutils literal notranslate"><span class="pre">ps.run()</span></code> helper function. The function adds some special
columns such as <code class="docutils literal notranslate"><span class="pre">_run_id</span></code> (once per <code class="docutils literal notranslate"><span class="pre">ps.run()</span></code> call) or <code class="docutils literal notranslate"><span class="pre">_pset_id</span></code> (once
per pset). Using <code class="docutils literal notranslate"><span class="pre">ps.run(...</span> <span class="pre">poolsize=...)</span></code> runs <code class="docutils literal notranslate"><span class="pre">func</span></code> in parallel on
<code class="docutils literal notranslate"><span class="pre">params</span></code> using <code class="docutils literal notranslate"><span class="pre">multiprocessing.Pool</span></code>.</p>
</section>
<section id="naming-of-database-fields">
<h2>Naming of database fields<a class="headerlink" href="#naming-of-database-fields" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">ps.run()</span></code> will add book-keeping fields starting with an underscore prefix
(e.g. <code class="docutils literal notranslate"><span class="pre">_pset_id</span></code>). By doing that, they can be distinguished from <code class="docutils literal notranslate"><span class="pre">pset</span></code> fields
<code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code>. We <em>recommend</em> but not require you to name all fields (dict keys)
generated in <code class="docutils literal notranslate"><span class="pre">func()</span></code> such as <code class="docutils literal notranslate"><span class="pre">result_</span></code> with a trailing or <em>postfix</em>
underscore. That way you can in the database clearly distinguish between
book-keeping (<code class="docutils literal notranslate"><span class="pre">_foo</span></code>), pset (<code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">b</span></code>) and result-type fields (<code class="docutils literal notranslate"><span class="pre">bar_</span></code>). But
again, this is only a suggestion, you can name the fields in a <code class="docutils literal notranslate"><span class="pre">pset</span></code> and the
ones created in <code class="docutils literal notranslate"><span class="pre">func()</span></code> any way you like. See <a class="reference internal" href="#s-more-on-db-field-names"><span class="std std-ref">this section for more
details</span></a>.</p>
</section>
<section id="building-parameter-grids">
<h2>Building parameter grids<a class="headerlink" href="#building-parameter-grids" title="Link to this heading">#</a></h2>
<p>This package offers some very simple helper functions which assist in creating
<code class="docutils literal notranslate"><span class="pre">params</span></code>. Basically, we define the to-be-varied parameters and then use
something like <code class="docutils literal notranslate"><span class="pre">itertools.product()</span></code> to loop over them to create <code class="docutils literal notranslate"><span class="pre">params</span></code>,
which is passed to <code class="docutils literal notranslate"><span class="pre">ps.run()</span></code> to actually perform the loop over all
<code class="docutils literal notranslate"><span class="pre">pset</span></code>s.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">psweep</span> <span class="k">as</span> <span class="nn">ps</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">=</span><span class="n">ps</span><span class="o">.</span><span class="n">plist</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">=</span><span class="n">ps</span><span class="o">.</span><span class="n">plist</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;xx&quot;</span><span class="p">,</span> <span class="s2">&quot;yy&quot;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span>
<span class="go">[{&#39;a&#39;: 1}, {&#39;a&#39;: 2}]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span>
<span class="go">[{&#39;b&#39;: &#39;xx&#39;}, {&#39;b&#39;: &#39;yy&#39;}]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
<span class="go">[({&#39;a&#39;: 1}, {&#39;b&#39;: &#39;xx&#39;}),</span>
<span class="go"> ({&#39;a&#39;: 1}, {&#39;b&#39;: &#39;yy&#39;}),</span>
<span class="go"> ({&#39;a&#39;: 2}, {&#39;b&#39;: &#39;xx&#39;}),</span>
<span class="go"> ({&#39;a&#39;: 2}, {&#39;b&#39;: &#39;yy&#39;})]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">ps</span><span class="o">.</span><span class="n">itr2params</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
<span class="go">[{&#39;a&#39;: 1, &#39;b&#39;: &#39;xx&#39;},</span>
<span class="go"> {&#39;a&#39;: 1, &#39;b&#39;: &#39;yy&#39;},</span>
<span class="go"> {&#39;a&#39;: 2, &#39;b&#39;: &#39;xx&#39;},</span>
<span class="go"> {&#39;a&#39;: 2, &#39;b&#39;: &#39;yy&#39;}]</span>
</pre></div>
</div>
<p>Here we used the helper function <code class="docutils literal notranslate"><span class="pre">itr2params()</span></code> which accepts an iterator
that represents the loops over params. It merges dicts to <code class="docutils literal notranslate"><span class="pre">pset</span></code>s and also deals
with nesting when using <code class="docutils literal notranslate"><span class="pre">zip()</span></code> (see below).</p>
<p>The last pattern is so common that we have a short-cut function
<code class="docutils literal notranslate"><span class="pre">pgrid()</span></code>, which basically does <code class="docutils literal notranslate"><span class="pre">itr2params(product(a,b))</span></code>.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ps</span><span class="o">.</span><span class="n">pgrid</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="go">[{&#39;a&#39;: 1, &#39;b&#39;: &#39;xx&#39;},</span>
<span class="go"> {&#39;a&#39;: 1, &#39;b&#39;: &#39;yy&#39;},</span>
<span class="go"> {&#39;a&#39;: 2, &#39;b&#39;: &#39;xx&#39;},</span>
<span class="go"> {&#39;a&#39;: 2, &#39;b&#39;: &#39;yy&#39;}]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">pgrid()</span></code> accepts either a sequence or individual args (but please
check the “pgrid gotchas” section below for some corner cases).</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ps</span><span class="o">.</span><span class="n">pgrid</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ps</span><span class="o">.</span><span class="n">pgrid</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
<p>So the logic of the param study is entirely contained in the creation of
<code class="docutils literal notranslate"><span class="pre">params</span></code>. For instance, if parameters shall be varied together (say <code class="docutils literal notranslate"><span class="pre">a</span></code> and
<code class="docutils literal notranslate"><span class="pre">b</span></code>), then use <code class="docutils literal notranslate"><span class="pre">zip</span></code>. The nesting from <code class="docutils literal notranslate"><span class="pre">zip()</span></code> is flattened in <code class="docutils literal notranslate"><span class="pre">itr2params()</span></code>
and <code class="docutils literal notranslate"><span class="pre">pgrid()</span></code>.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1">##ps.itr2params(zip(a, b))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ps</span><span class="o">.</span><span class="n">pgrid</span><span class="p">([</span><span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)])</span>
<span class="go">[{&#39;a&#39;: 1, &#39;b&#39;: &#39;xx&#39;},</span>
<span class="go"> {&#39;a&#39;: 2, &#39;b&#39;: &#39;yy&#39;}]</span>
</pre></div>
</div>
<p>Let’s add a third parameter to vary. Of course, in general, plists can have
different lengths.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">=</span><span class="n">ps</span><span class="o">.</span><span class="n">plist</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">88</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1">##ps.itr2params(product(zip(a, b), c))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1">##ps.pgrid([zip(a, b), c])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ps</span><span class="o">.</span><span class="n">pgrid</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">)</span>
<span class="go">[{&#39;a&#39;: 1, &#39;b&#39;: &#39;xx&#39;, &#39;c&#39;: 88},</span>
<span class="go"> {&#39;a&#39;: 1, &#39;b&#39;: &#39;xx&#39;, &#39;c&#39;: None},</span>
<span class="go"> {&#39;a&#39;: 1, &#39;b&#39;: &#39;xx&#39;, &#39;c&#39;: &#39;Z&#39;},</span>
<span class="go"> {&#39;a&#39;: 2, &#39;b&#39;: &#39;yy&#39;, &#39;c&#39;: 88},</span>
<span class="go"> {&#39;a&#39;: 2, &#39;b&#39;: &#39;yy&#39;, &#39;c&#39;: None},</span>
<span class="go"> {&#39;a&#39;: 2, &#39;b&#39;: &#39;yy&#39;, &#39;c&#39;: &#39;Z&#39;}]</span>
</pre></div>
</div>
<p>If you want to add a parameter which is constant, use a list of length one.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">const</span><span class="o">=</span><span class="n">ps</span><span class="o">.</span><span class="n">plist</span><span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.23</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ps</span><span class="o">.</span><span class="n">pgrid</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">,</span> <span class="n">const</span><span class="p">)</span>
<span class="go">[{&#39;a&#39;: 1, &#39;b&#39;: &#39;xx&#39;, &#39;c&#39;: 88,   &#39;const&#39;: 1.23},</span>
<span class="go"> {&#39;a&#39;: 1, &#39;b&#39;: &#39;xx&#39;, &#39;c&#39;: None, &#39;const&#39;: 1.23},</span>
<span class="go"> {&#39;a&#39;: 1, &#39;b&#39;: &#39;xx&#39;, &#39;c&#39;: &#39;Z&#39;,  &#39;const&#39;: 1.23},</span>
<span class="go"> {&#39;a&#39;: 2, &#39;b&#39;: &#39;yy&#39;, &#39;c&#39;: 88,   &#39;const&#39;: 1.23},</span>
<span class="go"> {&#39;a&#39;: 2, &#39;b&#39;: &#39;yy&#39;, &#39;c&#39;: None, &#39;const&#39;: 1.23},</span>
<span class="go"> {&#39;a&#39;: 2, &#39;b&#39;: &#39;yy&#39;, &#39;c&#39;: &#39;Z&#39;,  &#39;const&#39;: 1.23}]</span>
</pre></div>
</div>
<p>Besides <code class="docutils literal notranslate"><span class="pre">pgrid()</span></code>, we have another convenience function <code class="docutils literal notranslate"><span class="pre">stargrid()</span></code>, which
creates a specific param sampling pattern, where we vary params in a “star”
pattern (and not a full pgrid) around constant values (middle of the “star”).</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">const</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">77</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">=</span><span class="n">ps</span><span class="o">.</span><span class="n">plist</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">=</span><span class="n">ps</span><span class="o">.</span><span class="n">plist</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">77</span><span class="p">,</span><span class="mi">88</span><span class="p">,</span><span class="mi">99</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ps</span><span class="o">.</span><span class="n">stargrid</span><span class="p">(</span><span class="n">const</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
<span class="go">[{&#39;a&#39;: 1, &#39;b&#39;: 77, &#39;c&#39;: 11},</span>
<span class="go"> {&#39;a&#39;: 2, &#39;b&#39;: 77, &#39;c&#39;: 11},</span>
<span class="go"> {&#39;a&#39;: 3, &#39;b&#39;: 77, &#39;c&#39;: 11},</span>
<span class="go"> {&#39;a&#39;: 4, &#39;b&#39;: 77, &#39;c&#39;: 11},</span>
<span class="go"> {&#39;a&#39;: 1, &#39;b&#39;: 88, &#39;c&#39;: 11},</span>
<span class="go"> {&#39;a&#39;: 1, &#39;b&#39;: 99, &#39;c&#39;: 11}]</span>
</pre></div>
</div>
<p>This is useful in cases where you know that parameters are independent and you
want to do just a “line scan” for each parameter around known good values.</p>
<p>So, as you can see, the general idea is that we do all the loops
<em>before</em> running any workload, i.e. we assemble the parameter grid to be
sampled before the actual calculations. This has proven to be very
practical as it helps detecting errors early.</p>
<p>You are, by the way, of course not restricted to use simple nested loops
over parameters using <code class="docutils literal notranslate"><span class="pre">pgrid()</span></code> (which uses <code class="docutils literal notranslate"><span class="pre">itertools.product()</span></code>). You
are totally free in how to create <code class="docutils literal notranslate"><span class="pre">params</span></code>, be it using other fancy
stuff from <code class="docutils literal notranslate"><span class="pre">itertools</span></code> or explicit loops. Of course you can also define
a static <code class="docutils literal notranslate"><span class="pre">params</span></code> list</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>    <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="s1">&#39;xx&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>    <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="s1">&#39;yy&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mf">1.234</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="s1">&#39;xx&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="s1">&#39;X&#39;</span><span class="p">},</span>
    <span class="o">...</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>or read <code class="docutils literal notranslate"><span class="pre">params</span></code> in from an external source such as a database from a
previous study, etc.</p>
<p>The point is: you generate <code class="docutils literal notranslate"><span class="pre">params</span></code>, we run the study.</p>
<section id="how-to-define-default-params">
<h3>How to define default params<a class="headerlink" href="#how-to-define-default-params" title="Link to this heading">#</a></h3>
<p>There are two ways to do this. You can use a list of length 1 as mentioned
above with the <code class="docutils literal notranslate"><span class="pre">const</span></code> param. This will end up in the database, which is
(probably) what you want. So, let’s define a default value for “c” this way.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">plist</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">plist</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">88</span><span class="p">,</span> <span class="mi">99</span><span class="p">])</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">plist</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.23</span><span class="p">])</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">pgrid</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>Another solution is to define defaults in <code class="docutils literal notranslate"><span class="pre">func</span></code>, like so:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">pset</span><span class="p">,</span> <span class="n">c_default</span><span class="o">=</span><span class="mf">1.23</span><span class="p">):</span>
    <span class="n">a_val</span> <span class="o">=</span> <span class="n">pset</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span>
    <span class="n">b_val</span> <span class="o">=</span> <span class="n">pset</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span>
    <span class="c1"># Use c_default if &quot;c&quot; is not in pset.</span>
    <span class="n">c_val</span> <span class="o">=</span> <span class="n">pset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">c_default</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result_&quot;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="n">a_val</span> <span class="o">*</span> <span class="n">b_val</span> <span class="o">*</span> <span class="n">c_val</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="n">c_val</span><span class="p">}</span>
</pre></div>
</div>
<p>In this case, the default value of param “c” won’t end up in the database,
unless we add it to the returned dict, which we did in the example above.</p>
</section>
<section id="gotchas">
<h3>Gotchas<a class="headerlink" href="#gotchas" title="Link to this heading">#</a></h3>
<section id="pgrid">
<h4><code class="docutils literal notranslate"><span class="pre">pgrid</span></code><a class="headerlink" href="#pgrid" title="Link to this heading">#</a></h4>
<p>tl;dr: <code class="docutils literal notranslate"><span class="pre">pgrid(a,b,...)</span></code> is a convenience API. It can’t handle all corner
cases. If in doubt, use <code class="docutils literal notranslate"><span class="pre">pgrid([a,b,...])</span></code> (or even <code class="docutils literal notranslate"><span class="pre">itr2params(product(...))</span></code>
directly).</p>
<p>Note that for a single param we have</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">=</span><span class="n">ps</span><span class="o">.</span><span class="n">plist</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span>
<span class="go">[{&#39;a&#39;: 1}, {&#39;a&#39;: 2}]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ps</span><span class="o">.</span><span class="n">pgrid</span><span class="p">([</span><span class="n">a</span><span class="p">])</span>
<span class="go">[{&#39;a&#39;: 1}, {&#39;a&#39;: 2}]</span>
</pre></div>
</div>
<p>i.e. the loop from <code class="docutils literal notranslate"><span class="pre">itertools.product()</span></code> is over <code class="docutils literal notranslate"><span class="pre">[a]</span></code> which returns <code class="docutils literal notranslate"><span class="pre">a</span></code>
itself. You can leave off <code class="docutils literal notranslate"><span class="pre">[...]</span></code> if you have at least two args, say <code class="docutils literal notranslate"><span class="pre">a</span></code> and
<code class="docutils literal notranslate"><span class="pre">b</span></code> as in</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pgrid</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pgrid</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
<p>For a single arg calling <code class="docutils literal notranslate"><span class="pre">pgrid(a)</span></code> is wrong since then <code class="docutils literal notranslate"><span class="pre">itertools.product()</span></code>
will be called on the entries of <code class="docutils literal notranslate"><span class="pre">a</span></code> which is not what you want. In fact doing
so will raise an error.</p>
<p>Also, in case</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pgrid</span><span class="p">([</span><span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)])</span>
</pre></div>
</div>
<p>the list <code class="docutils literal notranslate"><span class="pre">[zip(a,b)]</span></code> is what you want to loop over and <code class="docutils literal notranslate"><span class="pre">pgrid(zip(a,b))</span></code> will
raise an error, just as in case <code class="docutils literal notranslate"><span class="pre">pgrid(a)</span></code> above.</p>
<p>And as before, if you have more plists, then <code class="docutils literal notranslate"><span class="pre">[...]</span></code> is optional, e.g.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pgrid</span><span class="p">([</span><span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pgrid</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="zip">
<h4><code class="docutils literal notranslate"><span class="pre">zip</span></code><a class="headerlink" href="#zip" title="Link to this heading">#</a></h4>
<p>When using <code class="docutils literal notranslate"><span class="pre">zip(a,b)</span></code>, make sure that <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> have the same length, else <code class="docutils literal notranslate"><span class="pre">zip</span></code>
will return an iterator whose length is <code class="docutils literal notranslate"><span class="pre">min(len(a),</span> <span class="pre">len(b))</span></code>.</p>
</section>
</section>
</section>
<section id="the-database">
<h2>The database<a class="headerlink" href="#the-database" title="Link to this heading">#</a></h2>
<p>By default, <code class="docutils literal notranslate"><span class="pre">ps.run()</span></code> writes a database <code class="docutils literal notranslate"><span class="pre">calc/database.pk</span></code> (a pickled
DataFrame) with the default <code class="docutils literal notranslate"><span class="pre">calc_dir='calc'</span></code>. You can turn that off using
<code class="docutils literal notranslate"><span class="pre">save=False</span></code> if you want. If you run <code class="docutils literal notranslate"><span class="pre">ps.run()</span></code> again</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">other_params</span><span class="p">)</span>
</pre></div>
</div>
<p>it will read and append to that file. The same happens in an interactive
session when you pass in <code class="docutils literal notranslate"><span class="pre">df</span></code> again, in which case we don’t read it from disk:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># default is df=None -&gt; create empty df</span>
<span class="c1"># save=False: don&#39;t write db to disk, optional</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">df_run_0</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">df_run_0_and_1</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">other_params</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df_run_0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="special-database-fields-and-repeated-runs">
<h2>Special database fields and repeated runs<a class="headerlink" href="#special-database-fields-and-repeated-runs" title="Link to this heading">#</a></h2>
<p>See <code class="docutils literal notranslate"><span class="pre">examples/*repeat.py</span></code>.</p>
<p>It is important to get the difference between the two special fields
<code class="docutils literal notranslate"><span class="pre">_run_id</span></code> and <code class="docutils literal notranslate"><span class="pre">_pset_id</span></code>, the most important one being <code class="docutils literal notranslate"><span class="pre">_pset_id</span></code>.</p>
<p>Both are random UUIDs. They are used to uniquely identify things.</p>
<p>Once per <code class="docutils literal notranslate"><span class="pre">ps.run()</span></code> call, a <code class="docutils literal notranslate"><span class="pre">_run_id</span></code> and <code class="docutils literal notranslate"><span class="pre">_run_seq</span></code> is created. Which
means that when you call <code class="docutils literal notranslate"><span class="pre">ps.run()</span></code> multiple times <em>using the same
database</em> as just shown, you will see multiple (in this case two) <code class="docutils literal notranslate"><span class="pre">_run_id</span></code>
and <code class="docutils literal notranslate"><span class="pre">_run_seq</span></code> values.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                             <span class="n">_run_id</span>                              <span class="n">_pset_id</span>  <span class="n">_run_seq</span>  <span class="n">_pset_seq</span>
<span class="mi">8543</span><span class="n">fdad</span><span class="o">-</span><span class="mi">4426</span><span class="o">-</span><span class="mi">41</span><span class="n">cb</span><span class="o">-</span><span class="n">ab42</span><span class="o">-</span><span class="mi">8</span><span class="n">a80b1bebbe2</span>  <span class="mi">08</span><span class="n">cb5f7c</span><span class="o">-</span><span class="mi">8</span><span class="n">ce8</span><span class="o">-</span><span class="mi">451</span><span class="n">f</span><span class="o">-</span><span class="mi">846</span><span class="n">d</span><span class="o">-</span><span class="n">db5ac3bcc746</span>         <span class="mi">0</span>          <span class="mi">0</span>
<span class="mi">8543</span><span class="n">fdad</span><span class="o">-</span><span class="mi">4426</span><span class="o">-</span><span class="mi">41</span><span class="n">cb</span><span class="o">-</span><span class="n">ab42</span><span class="o">-</span><span class="mi">8</span><span class="n">a80b1bebbe2</span>  <span class="mi">18</span><span class="n">da3840</span><span class="o">-</span><span class="n">d00e</span><span class="o">-</span><span class="mi">4</span><span class="n">bdd</span><span class="o">-</span><span class="n">b29c</span><span class="o">-</span><span class="mi">68</span><span class="n">be2adb164e</span>         <span class="mi">0</span>          <span class="mi">1</span>
<span class="mi">8543</span><span class="n">fdad</span><span class="o">-</span><span class="mi">4426</span><span class="o">-</span><span class="mi">41</span><span class="n">cb</span><span class="o">-</span><span class="n">ab42</span><span class="o">-</span><span class="mi">8</span><span class="n">a80b1bebbe2</span>  <span class="n">bcc47205</span><span class="o">-</span><span class="mi">0919</span><span class="o">-</span><span class="mi">4084</span><span class="o">-</span><span class="mi">9</span><span class="n">f07</span><span class="o">-</span><span class="mi">072</span><span class="n">eb56ed5fd</span>         <span class="mi">0</span>          <span class="mi">2</span>
<span class="mi">969592</span><span class="n">bc</span><span class="o">-</span><span class="mf">65e6</span><span class="o">-</span><span class="mi">4315</span><span class="o">-</span><span class="mf">9e6</span><span class="n">b</span><span class="o">-</span><span class="mi">5</span><span class="n">d64b6eaa0b3</span>  <span class="mi">809064</span><span class="n">d6</span><span class="o">-</span><span class="n">c7aa</span><span class="o">-</span><span class="mf">4e43</span><span class="o">-</span><span class="mi">81</span><span class="n">ea</span><span class="o">-</span><span class="n">cebfd4f85a12</span>         <span class="mi">1</span>          <span class="mi">3</span>
<span class="mi">969592</span><span class="n">bc</span><span class="o">-</span><span class="mf">65e6</span><span class="o">-</span><span class="mi">4315</span><span class="o">-</span><span class="mf">9e6</span><span class="n">b</span><span class="o">-</span><span class="mi">5</span><span class="n">d64b6eaa0b3</span>  <span class="n">ef5f06d4</span><span class="o">-</span><span class="mi">8906</span><span class="o">-</span><span class="mi">4605</span><span class="o">-</span><span class="mi">99</span><span class="n">cb</span><span class="o">-</span><span class="mi">2</span><span class="n">a9550fdd8de</span>         <span class="mi">1</span>          <span class="mi">4</span>
<span class="mi">969592</span><span class="n">bc</span><span class="o">-</span><span class="mf">65e6</span><span class="o">-</span><span class="mi">4315</span><span class="o">-</span><span class="mf">9e6</span><span class="n">b</span><span class="o">-</span><span class="mi">5</span><span class="n">d64b6eaa0b3</span>  <span class="mi">162</span><span class="n">a7b8c</span><span class="o">-</span><span class="mi">3</span><span class="n">ab5</span><span class="o">-</span><span class="mi">41</span><span class="n">bb</span><span class="o">-</span><span class="mi">92</span><span class="n">cd</span><span class="o">-</span><span class="mf">1e5</span><span class="n">d0db0842f</span>         <span class="mi">1</span>          <span class="mi">5</span>
</pre></div>
</div>
<p>Each <code class="docutils literal notranslate"><span class="pre">ps.run()</span></code> call in turn calls <code class="docutils literal notranslate"><span class="pre">func(pset)</span></code> for each pset in <code class="docutils literal notranslate"><span class="pre">params</span></code>.
Each <code class="docutils literal notranslate"><span class="pre">func</span></code> invocation creates a unique <code class="docutils literal notranslate"><span class="pre">_pset_id</span></code> and increment the integer
counter <code class="docutils literal notranslate"><span class="pre">_pset_seq</span></code>. Thus, we have a very simple, yet powerful one-to-one
mapping and a way to refer to a specific pset.</p>
<p>An interesting special case (see <code class="docutils literal notranslate"><span class="pre">examples/vary_1_param_repeat_same.py</span></code>) is
when you call <code class="docutils literal notranslate"><span class="pre">ps.run()</span></code> multiple times using <em>the exact same</em> <code class="docutils literal notranslate"><span class="pre">params</span></code>,</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
<p>which is perfectly fine, e.g. in cases where you just want to sample more data
for the same <code class="docutils literal notranslate"><span class="pre">pset</span></code>s in <code class="docutils literal notranslate"><span class="pre">params</span></code> over and over again. In this case, you will
have as above two unique <code class="docutils literal notranslate"><span class="pre">_run_id</span></code>s, unique <code class="docutils literal notranslate"><span class="pre">_pset_id</span></code>s, but <em>two sets of the
same</em> <code class="docutils literal notranslate"><span class="pre">_pset_hash</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                             <span class="n">_run_id</span>                              <span class="n">_pset_id</span>  <span class="n">_run_seq</span>  <span class="n">_pset_seq</span>                                <span class="n">_pset_hash</span>  <span class="n">a</span>   <span class="n">result_</span>
<span class="mi">8543</span><span class="n">fdad</span><span class="o">-</span><span class="mi">4426</span><span class="o">-</span><span class="mi">41</span><span class="n">cb</span><span class="o">-</span><span class="n">ab42</span><span class="o">-</span><span class="mi">8</span><span class="n">a80b1bebbe2</span>  <span class="mi">08</span><span class="n">cb5f7c</span><span class="o">-</span><span class="mi">8</span><span class="n">ce8</span><span class="o">-</span><span class="mi">451</span><span class="n">f</span><span class="o">-</span><span class="mi">846</span><span class="n">d</span><span class="o">-</span><span class="n">db5ac3bcc746</span>         <span class="mi">0</span>          <span class="mi">0</span>  <span class="n">e4ad4daad53a2eec0313386ada88211e50d693bd</span>  <span class="mi">1</span>  <span class="mf">0.381589</span>
<span class="mi">8543</span><span class="n">fdad</span><span class="o">-</span><span class="mi">4426</span><span class="o">-</span><span class="mi">41</span><span class="n">cb</span><span class="o">-</span><span class="n">ab42</span><span class="o">-</span><span class="mi">8</span><span class="n">a80b1bebbe2</span>  <span class="mi">18</span><span class="n">da3840</span><span class="o">-</span><span class="n">d00e</span><span class="o">-</span><span class="mi">4</span><span class="n">bdd</span><span class="o">-</span><span class="n">b29c</span><span class="o">-</span><span class="mi">68</span><span class="n">be2adb164e</span>         <span class="mi">0</span>          <span class="mi">1</span>  <span class="mi">7</span><span class="n">b7ee754248759adcee9e62a4c1477ed1a8bb1ab</span>  <span class="mi">2</span>  <span class="mf">1.935220</span>
<span class="mi">8543</span><span class="n">fdad</span><span class="o">-</span><span class="mi">4426</span><span class="o">-</span><span class="mi">41</span><span class="n">cb</span><span class="o">-</span><span class="n">ab42</span><span class="o">-</span><span class="mi">8</span><span class="n">a80b1bebbe2</span>  <span class="n">bcc47205</span><span class="o">-</span><span class="mi">0919</span><span class="o">-</span><span class="mi">4084</span><span class="o">-</span><span class="mi">9</span><span class="n">f07</span><span class="o">-</span><span class="mi">072</span><span class="n">eb56ed5fd</span>         <span class="mi">0</span>          <span class="mi">2</span>  <span class="mf">9e0</span><span class="n">e6d8a99c72daf40337183358cbef91bba7311</span>  <span class="mi">3</span>  <span class="mf">2.187107</span>
<span class="mi">969592</span><span class="n">bc</span><span class="o">-</span><span class="mf">65e6</span><span class="o">-</span><span class="mi">4315</span><span class="o">-</span><span class="mf">9e6</span><span class="n">b</span><span class="o">-</span><span class="mi">5</span><span class="n">d64b6eaa0b3</span>  <span class="mi">809064</span><span class="n">d6</span><span class="o">-</span><span class="n">c7aa</span><span class="o">-</span><span class="mf">4e43</span><span class="o">-</span><span class="mi">81</span><span class="n">ea</span><span class="o">-</span><span class="n">cebfd4f85a12</span>         <span class="mi">1</span>          <span class="mi">3</span>  <span class="n">e4ad4daad53a2eec0313386ada88211e50d693bd</span>  <span class="mi">1</span>  <span class="mf">0.590200</span>
<span class="mi">969592</span><span class="n">bc</span><span class="o">-</span><span class="mf">65e6</span><span class="o">-</span><span class="mi">4315</span><span class="o">-</span><span class="mf">9e6</span><span class="n">b</span><span class="o">-</span><span class="mi">5</span><span class="n">d64b6eaa0b3</span>  <span class="n">ef5f06d4</span><span class="o">-</span><span class="mi">8906</span><span class="o">-</span><span class="mi">4605</span><span class="o">-</span><span class="mi">99</span><span class="n">cb</span><span class="o">-</span><span class="mi">2</span><span class="n">a9550fdd8de</span>         <span class="mi">1</span>          <span class="mi">4</span>  <span class="mi">7</span><span class="n">b7ee754248759adcee9e62a4c1477ed1a8bb1ab</span>  <span class="mi">2</span>  <span class="mf">1.322758</span>
<span class="mi">969592</span><span class="n">bc</span><span class="o">-</span><span class="mf">65e6</span><span class="o">-</span><span class="mi">4315</span><span class="o">-</span><span class="mf">9e6</span><span class="n">b</span><span class="o">-</span><span class="mi">5</span><span class="n">d64b6eaa0b3</span>  <span class="mi">162</span><span class="n">a7b8c</span><span class="o">-</span><span class="mi">3</span><span class="n">ab5</span><span class="o">-</span><span class="mi">41</span><span class="n">bb</span><span class="o">-</span><span class="mi">92</span><span class="n">cd</span><span class="o">-</span><span class="mf">1e5</span><span class="n">d0db0842f</span>         <span class="mi">1</span>          <span class="mi">5</span>  <span class="mf">9e0</span><span class="n">e6d8a99c72daf40337183358cbef91bba7311</span>  <span class="mi">3</span>  <span class="mf">1.639455</span>
</pre></div>
</div>
<p>This is a very powerful tool to filter the database for calculations that used
the same pset, e.g. an exact repetition of one experiment. But since we use
UUIDs for <code class="docutils literal notranslate"><span class="pre">_pset_id</span></code>, those calculations can still be distinguished.</p>
<section id="filter-by-pset-hashes">
<h3>Filter by <code class="docutils literal notranslate"><span class="pre">pset</span></code> hashes<a class="headerlink" href="#filter-by-pset-hashes" title="Link to this heading">#</a></h3>
<p>As mentioned, we create a hash for each <code class="docutils literal notranslate"><span class="pre">pset</span></code>, which is stored in the
<code class="docutils literal notranslate"><span class="pre">_pset_hash</span></code> database column. This unlocks powerful database filter options.</p>
<p>As shown above, when calling <code class="docutils literal notranslate"><span class="pre">run()</span></code> twice
with the same <code class="docutils literal notranslate"><span class="pre">params</span></code> you get a second set of calculations. But suppose you
have a script where you keep modifying the way you create <code class="docutils literal notranslate"><span class="pre">params</span></code> and you just
want to add some more scans <em>without</em> removing the code that generated the old
<code class="docutils literal notranslate"><span class="pre">params</span></code> that you already have in the database. In that case use</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">skip_dups</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>This will skip all <code class="docutils literal notranslate"><span class="pre">pset</span></code>s already in the database based on their hash and
only add calculations for new <code class="docutils literal notranslate"><span class="pre">pset</span></code>s.</p>
</section>
<section id="more-details-on-naming-database-fields">
<span id="s-more-on-db-field-names"></span><h3>More details on naming database fields<a class="headerlink" href="#more-details-on-naming-database-fields" title="Link to this heading">#</a></h3>
<p>We implement the convention to ignore fields starting and ending in an
underscore at the moment only internally in <code class="docutils literal notranslate"><span class="pre">ps.pset_hash()</span></code> to ensure that the
hash includes only <code class="docutils literal notranslate"><span class="pre">pset</span></code> variables. However, when <code class="docutils literal notranslate"><span class="pre">ps.run()</span></code> is called, the
hash is calculated <em>before</em> book-keeping fields like <code class="docutils literal notranslate"><span class="pre">_pset_id</span></code> are added and
<code class="docutils literal notranslate"><span class="pre">func()</span></code> is called to, for instance, return <code class="docutils literal notranslate"><span class="pre">{'result_':</span> <span class="pre">1.234}</span></code> and update the
<code class="docutils literal notranslate"><span class="pre">pset</span></code>. Therefore, this convention is in fact not needed. It only takes effect
should you ever want to re-calculate the hash, as in</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<span class="gp">... </span>   <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;_pset_hash_new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">pset_hash</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span>
<span class="go">   a                                _pset_hash                              _pset_id  ...   result_                            _pset_hash_new</span>
<span class="go">0  1  64846e128be5c974d6194f77557d0511542835a8  61f899a8-314b-4a19-a359-3502e3e2d009  ...  0.880328  64846e128be5c974d6194f77557d0511542835a8</span>
<span class="go">1  2  e746f91e51f09064bd7f1e516701ba7d0d908653  cd1dc05b-0fab-4e09-9798-9de94a5b3cd3  ...  0.815945  e746f91e51f09064bd7f1e516701ba7d0d908653</span>
<span class="go">2  3  96da150761c9d66b31975f11ef44bfb75c2fdc11  6612eab6-5d5a-4fbf-ae18-fdb4846fd459  ...  0.096946  96da150761c9d66b31975f11ef44bfb75c2fdc11</span>
<span class="go">3  4  79ba178b3895a603bf9d84dea82e034791e8fe30  bf5bf881-3273-4932-a3f3-9c117bca921b  ...  2.606486  79ba178b3895a603bf9d84dea82e034791e8fe30</span>
</pre></div>
</div>
<p>Here the hash goes only over the <code class="docutils literal notranslate"><span class="pre">a</span></code> field, so <code class="docutils literal notranslate"><span class="pre">_pset_hash</span></code> and <code class="docutils literal notranslate"><span class="pre">_pset_hash_new</span></code>
must be the same.</p>
<p>We may provide tooling for that in the future. See also
<a class="github reference external" href="https://github.com/elcorto/psweep/issues/15">elcorto/psweep#15</a> .</p>
</section>
</section>
<section id="best-practices">
<h2>Best practices<a class="headerlink" href="#best-practices" title="Link to this heading">#</a></h2>
<p>The following workflows and practices come from experience. They are, if
you will, the “framework” for how to do things. However, we decided to
not codify any of these ideas but to only provide tools to make them
happen easily, because you will probably have quite different
requirements and workflows.</p>
<p>Please also have a look at the <code class="docutils literal notranslate"><span class="pre">examples/</span></code> dir where we document these
and more common workflows.</p>
<section id="save-data-on-disk-use-uuids">
<h3>Save data on disk, use UUIDs<a class="headerlink" href="#save-data-on-disk-use-uuids" title="Link to this heading">#</a></h3>
<p>Assume that you need to save results from a <code class="docutils literal notranslate"><span class="pre">func()</span></code> call not only in the
returned dict from <code class="docutils literal notranslate"><span class="pre">func</span></code> (or even not at all!) but on disk, for instance when
you call an external program which saves data on disk. Consider this toy
example (<code class="docutils literal notranslate"><span class="pre">examples/save_data_on_disk/10run.py</span></code>):</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">psweep</span> <span class="k">as</span> <span class="nn">ps</span>


<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">pset</span><span class="p">):</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pset</span><span class="p">[</span><span class="s2">&quot;_calc_dir&quot;</span><span class="p">],</span> <span class="n">pset</span><span class="p">[</span><span class="s2">&quot;_pset_id&quot;</span><span class="p">],</span> <span class="s2">&quot;output.txt&quot;</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;mkdir -p $(dirname </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">); &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;echo </span><span class="si">{</span><span class="n">pset</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">pset</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">pset</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="n">cmd</span><span class="p">}</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">plist</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case, you call an external program (here a dummy shell command) which
saves its output on disk. Note that we don’t return any output from the
external command in <code class="docutils literal notranslate"><span class="pre">func</span></code>’s <code class="docutils literal notranslate"><span class="pre">return</span></code> statement. We only update the database
row added for each call to <code class="docutils literal notranslate"><span class="pre">func</span></code> by returning a dict <code class="docutils literal notranslate"><span class="pre">{&quot;cmd&quot;:</span> <span class="pre">cmd}</span></code> with the
shell <code class="docutils literal notranslate"><span class="pre">cmd</span></code> we call in order to have that in the database.</p>
<p>Also note how we use the special fields <code class="docutils literal notranslate"><span class="pre">_pset_id</span></code> and <code class="docutils literal notranslate"><span class="pre">_calc_dir</span></code>, which are
added in <code class="docutils literal notranslate"><span class="pre">ps.run()</span></code> to <code class="docutils literal notranslate"><span class="pre">pset</span></code> <em>before</em> <code class="docutils literal notranslate"><span class="pre">func</span></code> is called.</p>
<p>After the run, we have four dirs for each pset, each simply named with
<code class="docutils literal notranslate"><span class="pre">_pset_id</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>calc
├── 63b5daae-1b37-47e9-a11c-463fb4934d14
│   └── output.txt
├── 657cb9f9-8720-4d4c-8ff1-d7ddc7897700
│   └── output.txt
├── d7849792-622d-4479-aec6-329ed8bedd9b
│   └── output.txt
├── de8ac159-b5d0-4df6-9e4b-22ebf78bf9b0
│   └── output.txt
└── database.pk
</pre></div>
</div>
<p>This is a useful pattern. History has shown that in the end, most naming
conventions start simple but turn out to be inflexible and hard to adapt
later on. I have seen people write scripts which create things like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>calc/param_a=1.2_param_b=66.77
calc/param_a=3.4_param_b=88.99
</pre></div>
</div>
<p>i.e. encode the parameter values in path names, because they don’t have
a database. Good luck parsing that. I don’t say this cannot be done –
sure it can (in fact the example above easy to parse). It is just not
fun – and there is no need to. What if you need to add a “column”
for parameter ‘c’ later? Impossible (well, painful at least). This
approach makes sense for very quick throw-away test runs, but gets out
of hand quickly.</p>
<p>Since we have a database, we can simply drop all data in
<code class="docutils literal notranslate"><span class="pre">calc/&lt;pset_id&gt;</span></code> and be done with it. Each parameter set is identified
by a UUID that will never change. This is the only kind of naming
convention which makes sense in the long run.</p>
</section>
<section id="post-processing">
<h3>Post-processing<a class="headerlink" href="#post-processing" title="Link to this heading">#</a></h3>
<p>An example of a simple post-processing script that reads data from disk
(<code class="docutils literal notranslate"><span class="pre">examples/save_data_on_disk/20eval.py</span></code>):</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">df_read</span><span class="p">(</span><span class="s2">&quot;calc/database.pk&quot;</span><span class="p">)</span>

<span class="c1"># Filter database</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>

<span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;calc/</span><span class="si">{</span><span class="n">pset_id</span><span class="si">}</span><span class="s2">/output.txt&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">pset_id</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">_pset_id</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Add new column to database, print and write new eval database</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;_pset_id&quot;</span><span class="p">]</span>
<span class="n">ps</span><span class="o">.</span><span class="n">df_print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">])</span>

<span class="n">ps</span><span class="o">.</span><span class="n">df_write</span><span class="p">(</span><span class="s2">&quot;calc/database_eval.pk&quot;</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="iterative-extension-of-a-parameter-study">
<h3>Iterative extension of a parameter study<a class="headerlink" href="#iterative-extension-of-a-parameter-study" title="Link to this heading">#</a></h3>
<p>See <code class="docutils literal notranslate"><span class="pre">examples/multiple_local_1d_scans/</span></code> and <code class="docutils literal notranslate"><span class="pre">examples/*repeat*</span></code>.</p>
<p>You can backup old calc dirs when repeating calls to <code class="docutils literal notranslate"><span class="pre">ps.run()</span></code> using the
<code class="docutils literal notranslate"><span class="pre">backup</span></code> keyword.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>This will save a copy of the old <code class="docutils literal notranslate"><span class="pre">calc_dir</span></code> to something like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">calc</span><span class="o">.</span><span class="n">bak_2021</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">19</span><span class="n">T23</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">33.621004</span><span class="n">Z_run_id_d309c2c6</span><span class="o">-</span><span class="n">e4ba</span><span class="o">-</span><span class="mi">4</span><span class="n">ef4</span><span class="o">-</span><span class="mi">934</span><span class="n">c</span><span class="o">-</span><span class="mi">2</span><span class="n">a4b2df07941</span>
</pre></div>
</div>
<p>That way, you can track old states of the overall study, and recover from
mistakes, e.g. by just</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>rm<span class="w"> </span>-r<span class="w"> </span>calc
$<span class="w"> </span>mv<span class="w"> </span>calc.bak_2021-03-19T2*<span class="w"> </span>calc
</pre></div>
</div>
<p>For any non-trivial work, you won’t use an interactive session. Instead, you
will have a driver script (say <code class="docutils literal notranslate"><span class="pre">input.py</span></code>, or a jupyter notebook, or …) which
defines <code class="docutils literal notranslate"><span class="pre">params</span></code> and starts <code class="docutils literal notranslate"><span class="pre">ps.run()</span></code>. Also in a common workflow, you
won’t define <code class="docutils literal notranslate"><span class="pre">params</span></code> and run a study once. Instead you will first have an idea
about which parameter values to scan. You will start with a coarse grid of
parameters and then inspect the results and identify regions where you need
more data (e.g. more dense sampling). Then you will modify <code class="docutils literal notranslate"><span class="pre">params</span></code> and run the
study again. You will modify <code class="docutils literal notranslate"><span class="pre">input.py</span></code> multiple times, as you refine your
study.</p>
</section>
<section id="use-git">
<h3>Use git<a class="headerlink" href="#use-git" title="Link to this heading">#</a></h3>
<p>Instead or in addition to using</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>we recommend a <code class="docutils literal notranslate"><span class="pre">git</span></code>-based workflow to at least track changes to <code class="docutils literal notranslate"><span class="pre">input.py</span></code>
(instead of manually creating backups such as <code class="docutils literal notranslate"><span class="pre">input.py.0</span></code>, <code class="docutils literal notranslate"><span class="pre">input.py.1</span></code>, …). You
can manually <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span></code> at any point of course, or use</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">git</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>This will commit any changes made to e.g. <code class="docutils literal notranslate"><span class="pre">input.py</span></code> itself and create a commit
message containing the current <code class="docutils literal notranslate"><span class="pre">_run_id</span></code> such as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">psweep</span><span class="p">:</span> <span class="n">batch_templates_git</span><span class="p">:</span> <span class="n">run_id</span><span class="o">=</span><span class="mi">68</span><span class="n">f5d9b7</span><span class="o">-</span><span class="n">efa6</span><span class="o">-</span><span class="mi">4</span><span class="n">ed8</span><span class="o">-</span><span class="mi">9384</span><span class="o">-</span><span class="mi">4</span><span class="n">ffccab6f7c5</span>
</pre></div>
</div>
<p>We <strong>strongly recommend</strong> to create a <code class="docutils literal notranslate"><span class="pre">.gitignore</span></code> such as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## ignore backups</span>
<span class="n">calc</span><span class="o">.</span><span class="n">bak</span><span class="o">*</span>

<span class="c1"># ignore simulate runs</span>
<span class="n">calc</span><span class="o">.</span><span class="n">simulate</span>

<span class="c1"># ignore the whole calc/ dir, track only scripts</span>
<span class="c1">##calc/</span>

<span class="c1"># or just ignore potentially big files coming from a simulation you run</span>
<span class="n">calc</span><span class="o">/*/*.</span><span class="n">bin</span>
</pre></div>
</div>
<section id="how-to-handle-large-files-when-using-git">
<h4>How to handle large files when using git<a class="headerlink" href="#how-to-handle-large-files-when-using-git" title="Link to this heading">#</a></h4>
<p>The first option is to <code class="docutils literal notranslate"><span class="pre">.gitignore</span></code> them. Another is to use
<a class="reference external" href="https://git-lfs.github.com"><code class="docutils literal notranslate"><span class="pre">git-lfs</span></code></a> (see the section on that later). That way you track their
changes but only store the most recent version. Or you leave those files on
another local or remote storage and store only the path to them (and maybe a
hash) in the database. It’s up to you.</p>
<p>Again, we don’t enforce a specific workflow but instead just provide basic
building blocks.</p>
</section>
</section>
<section id="simulate-dry-run-look-before-you-leap">
<h3>Simulate / Dry-Run: look before you leap<a class="headerlink" href="#simulate-dry-run-look-before-you-leap" title="Link to this heading">#</a></h3>
<p>See <code class="docutils literal notranslate"><span class="pre">examples/vary_1_param_simulate.py</span></code>.</p>
<p>When you fiddle with finding the next good <code class="docutils literal notranslate"><span class="pre">params</span></code> and even when using
<code class="docutils literal notranslate"><span class="pre">backup</span></code> and/or <code class="docutils literal notranslate"><span class="pre">git</span></code>, appending to the old database might be
a hassle if you find that you made a mistake when setting up <code class="docutils literal notranslate"><span class="pre">params</span></code>.
You need to abort the current run, copy the backup over or use <code class="docutils literal notranslate"><span class="pre">git</span></code> to go
back.</p>
<p>Instead, while you tinker with <code class="docutils literal notranslate"><span class="pre">params</span></code>, use another
<code class="docutils literal notranslate"><span class="pre">calc_dir</span></code>, e.g.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># only needed so that we can copy the old database over</span>
$<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>calc.simulate
$<span class="w"> </span>cp<span class="w"> </span>calc/database.pk<span class="w"> </span>calc.simulate/
</pre></div>
</div>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">calc_dir</span><span class="o">=</span><span class="s1">&#39;calc.simulate&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>But what’s even better: keep everything as it is and just set
<code class="docutils literal notranslate"><span class="pre">simulate=True</span></code>, which performs exactly the two steps above.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">simulate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>It will copy only the database, not all the (possible large) data in <code class="docutils literal notranslate"><span class="pre">calc/</span></code> to
<code class="docutils literal notranslate"><span class="pre">calc.simulate/</span></code> and run the study there. Additionally , it <em>will not call</em> call
<code class="docutils literal notranslate"><span class="pre">func()</span></code> to run any workload. So you still append to your old database as in a
real run, but in a safe separate dir which you can delete later.</p>
</section>
<section id="advanced-give-runs-names-for-easy-post-processing">
<h3>Advanced: Give runs names for easy post-processing<a class="headerlink" href="#advanced-give-runs-names-for-easy-post-processing" title="Link to this heading">#</a></h3>
<p>See <code class="docutils literal notranslate"><span class="pre">examples/vary_1_param_study_column.py</span></code>.</p>
<p>Post-processing is not the scope of the package. The database is a
<code class="docutils literal notranslate"><span class="pre">pandas</span></code> DataFrame and that’s it. You can query it and use your full <code class="docutils literal notranslate"><span class="pre">pandas</span></code>
Ninja skills here, e.g. “give me all <code class="docutils literal notranslate"><span class="pre">pset</span></code>s where parameter ‘a’ was
between 10 and 100, while ‘b’ was constant, …”. You get the idea.</p>
<p>To ease post-processing, it can be useful practice to add a constant parameter
named “study” or “scan” to label a certain range of runs. If you, for instance,
have 5 runs (meaning 5 calls to <code class="docutils literal notranslate"><span class="pre">ps.run()</span></code>) where you scan values for
parameter ‘a’ while keeping parameters ‘b’ and ‘c’ constant, you’ll have 5
<code class="docutils literal notranslate"><span class="pre">_run_id</span></code> values. When querying the database later, you could limit by
<code class="docutils literal notranslate"><span class="pre">_run_id</span></code> if you know the values:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">_run_id</span><span class="o">==</span><span class="s1">&#39;afa03dab-071e-472d-a396-37096580bfee&#39;</span><span class="p">)</span> <span class="o">|</span>
<span class="go">                     (df._run_id==&#39;e813db52-7fb9-4777-a4c8-2ce0dddc283c&#39;) |</span>
<span class="go">                     ...</span>
<span class="go">                     ]</span>
</pre></div>
</div>
<p>This doesn’t look like fun. It shows that the UUIDs (<code class="docutils literal notranslate"><span class="pre">_run_id</span></code> and
<code class="docutils literal notranslate"><span class="pre">_pset_id</span></code>) are rarely meant to be used directly, but rather to
programmatically link <code class="docutils literal notranslate"><span class="pre">pset</span></code>s and runs to other data (as shown above in the
“Save data on disk” example). You can also use the integer IDs <code class="docutils literal notranslate"><span class="pre">_run_seq</span></code> and
<code class="docutils literal notranslate"><span class="pre">_pset_seq</span></code> instead. But still, you need to know to which parameter values they
correspond to.</p>
<p>When possible, you could limit by the constant values of the other parameters:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">b</span><span class="o">==</span><span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">c</span><span class="o">==</span><span class="s1">&#39;foo&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p>Much better! This is what most post-processing scripts will do. In fact, we
have a shortcut function</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">conds</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">b</span><span class="o">==</span><span class="mi">10</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">c</span><span class="o">==</span><span class="s1">&#39;foo&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df_filtered</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">df_filter_conds</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">conds</span><span class="p">)</span>
</pre></div>
</div>
<p>which is useful in post-processing scripts where <code class="docutils literal notranslate"><span class="pre">conds</span></code> is
created programmatically.</p>
<p>But when you have a column “study” which has the value <code class="docutils literal notranslate"><span class="pre">'a'</span></code> all the
time, it is just</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">study</span><span class="o">==</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>You can do more powerful things with this approach. For instance, say
you vary parameters ‘a’ and ‘b’, then you could name the “study”
field ‘scan=a:b’ and encode which parameters (thus column names) you
have varied. Later in the post-processing</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">study</span> <span class="o">=</span> <span class="s1">&#39;scan=a:b&#39;</span>
<span class="go"># cols = [&#39;a&#39;, &#39;b&#39;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cols</span> <span class="o">=</span> <span class="n">study</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">values</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
<p>So in this case, a naming convention <em>is</em> useful in order to bypass
possibly complex database queries. But it is still flexible – you can
change the “study” column at any time, or delete it again.</p>
<p>Pro tip: You can manipulate the database at any later point and add the
“study” column after all runs have been done.</p>
<p>Super Pro tip: Make a backup of the database first!</p>
</section>
<section id="how-to-handle-failing-workloads">
<span id="s-wrap-failed-func"></span><h3>How to handle failing workloads<a class="headerlink" href="#how-to-handle-failing-workloads" title="Link to this heading">#</a></h3>
<p>If the code in <code class="docutils literal notranslate"><span class="pre">func()</span></code> fails and raises a Python exception, it will take
down the whole run (the call <code class="docutils literal notranslate"><span class="pre">run(func,</span> <span class="pre">params,</span> <span class="pre">...)</span></code>).</p>
<p>Sometimes we instead want to catch that, log the event, carry on and later
analyze the failed <code class="docutils literal notranslate"><span class="pre">pset</span></code>s. One way to do this is by wrapping <code class="docutils literal notranslate"><span class="pre">func</span></code> in a
<code class="docutils literal notranslate"><span class="pre">try</span></code>…<code class="docutils literal notranslate"><span class="pre">except</span></code> block, for example:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">traceback</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">pset</span><span class="p">):</span>
    <span class="o">...</span> <span class="n">here</span> <span class="n">be</span> <span class="n">code</span> <span class="o">...</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">safe_func</span><span class="p">(</span><span class="n">pset</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">pset</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_failed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_exc_txt</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pset</span><span class="si">=}</span><span class="s2"> failed, traceback:</span><span class="se">\n</span><span class="si">{</span><span class="n">txt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_failed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">_exc_txt</span><span class="o">=</span><span class="n">txt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">safe_func</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
<p>This will add a bool field <code class="docutils literal notranslate"><span class="pre">_failed</span></code> to the database, as well as a text field
<code class="docutils literal notranslate"><span class="pre">_exc_txt</span></code> which stores the exception’s traceback message.</p>
<p>We don’t implement this as a feature and only provide examples, which keeps
things flexible. Maybe you want <code class="docutils literal notranslate"><span class="pre">_failed</span></code> to be called <code class="docutils literal notranslate"><span class="pre">_crashed</span></code> instead, or you want
to log more data.</p>
<p>For post-processing, you would then do something like:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">df_read</span><span class="p">(</span><span class="s2">&quot;calc/database.pk&quot;</span><span class="p">)</span>

<span class="c1"># Only successful psets</span>
<span class="n">df_good</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">_failed</span><span class="p">]</span>

<span class="c1"># All failed pset</span>
<span class="n">df_fail</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">_failed</span><span class="p">]</span>

<span class="k">for</span> <span class="n">pset_id</span><span class="p">,</span> <span class="n">txt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df_fail</span><span class="o">.</span><span class="n">_pset_id</span><span class="p">,</span> <span class="n">df_fail</span><span class="o">.</span><span class="n">_exc_txt</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pset_id</span><span class="si">=}</span><span class="se">\n</span><span class="si">{</span><span class="n">txt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>See also <a class="reference external" href="https://github.com/elcorto/psweep/issues/1">this discussion</a> for
more.</p>
</section>
<section id="text-logging-per-pset">
<h3>Text logging per <code class="docutils literal notranslate"><span class="pre">pset</span></code><a class="headerlink" href="#text-logging-per-pset" title="Link to this heading">#</a></h3>
<p>All text sent to the terminal (<code class="docutils literal notranslate"><span class="pre">sys.stdout</span></code> and <code class="docutils literal notranslate"><span class="pre">sys.stderr</span></code>) by any code in
<code class="docutils literal notranslate"><span class="pre">func()</span></code> can be redirected to a database field <code class="docutils literal notranslate"><span class="pre">_logs</span></code>, a file
<code class="docutils literal notranslate"><span class="pre">&lt;calc_dir&gt;/&lt;pset_id&gt;/logs.txt</span></code>, or both, by using</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">capture_logs</span><span class="o">=</span><span class="s2">&quot;db&quot;</span><span class="p">)</span>
<span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">capture_logs</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">)</span>
<span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">capture_logs</span><span class="o">=</span><span class="s2">&quot;db+file&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>For <code class="docutils literal notranslate"><span class="pre">print()</span></code>-style logging, this is very convenient.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This feature may have side effects since it dynamically redirects
<code class="docutils literal notranslate"><span class="pre">sys.stdout</span></code> and <code class="docutils literal notranslate"><span class="pre">sys.stderr</span></code>, so code in <code class="docutils literal notranslate"><span class="pre">func()</span></code> making advanced use of
those may not work as intended.</p>
</div>
<p>To also log all text from shell commands that you call, make sure to capture
this on the Python side and print it. For example</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">subprocess</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">pset</span><span class="p">):</span>
    <span class="n">input_file_txt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">param_a=</span><span class="si">{</span><span class="n">pset</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">param_b=</span><span class="si">{</span><span class="n">pset</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">pset_id</span> <span class="o">=</span> <span class="n">pset</span><span class="p">[</span><span class="s2">&quot;_pset_id&quot;</span><span class="p">]</span>
    <span class="n">ps</span><span class="o">.</span><span class="n">file_write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;calc/</span><span class="si">{</span><span class="n">pset_id</span><span class="si">}</span><span class="s2">/input.txt&quot;</span><span class="p">,</span> <span class="n">input_file_txt</span><span class="p">)</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;cd calc/</span><span class="si">{</span><span class="n">pset_id</span><span class="si">}</span><span class="s2">; my_fortran_simulation_code.x &lt; input.txt | tee output.txt&quot;</span><span class="p">,</span>
        <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>

<span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">capture_logs</span><span class="o">=</span><span class="s2">&quot;db+file&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This will log all text output and errors from the command executed by
<code class="docutils literal notranslate"><span class="pre">subprocess.run()</span></code>. In this example we use <code class="docutils literal notranslate"><span class="pre">subprocess.run(...,</span> <span class="pre">check=False)</span></code>
which prevents raising an exception in case of a shell error (exit code != 0).
To detect and log a fail, you may look into <code class="docutils literal notranslate"><span class="pre">txt</span></code> for signs of an error,
either directly in <code class="docutils literal notranslate"><span class="pre">func()</span></code>, or later in post-processing, for example using
regular expressions (see also <a class="reference external" href="https://github.com/elcorto/psweep/issues/1">this
discussion</a>). But you can also use
<code class="docutils literal notranslate"><span class="pre">check=True</span></code> and wrap the function <a class="reference internal" href="#s-wrap-failed-func"><span class="std std-ref">as described earlier</span></a>.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">pset</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="c1"># Same as above only that check=True</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">safe_func</span><span class="p">(</span><span class="n">pset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple safe_func that doesn&#39;t create new database fields.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">pset</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>

<span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">safe_func</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">capture_logs</span><span class="o">=</span><span class="s2">&quot;db+file&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>See also <code class="docutils literal notranslate"><span class="pre">examples/capture_logs.py</span></code> for a worked example.</p>
</section>
</section>
<section id="running-on-hpc-compute-infrastructure">
<span id="s-distributed"></span><h2>Running on (HPC) compute infrastructure<a class="headerlink" href="#running-on-hpc-compute-infrastructure" title="Link to this heading">#</a></h2>
<p>We have support for managing calculations on remote systems such
as HPC clusters with a batch system like SLURM.</p>
<p>You can use <code class="docutils literal notranslate"><span class="pre">dask</span></code> tooling or a template-based workflow. Both have their
pros and cons (no free lunch!), but try <code class="docutils literal notranslate"><span class="pre">dask</span></code> first.</p>
<section id="dask">
<h3><code class="docutils literal notranslate"><span class="pre">dask</span></code><a class="headerlink" href="#dask" title="Link to this heading">#</a></h3>
<p>Overview of <code class="docutils literal notranslate"><span class="pre">dask</span></code>’s architecture (from <a class="reference external" href="https://docs.dask.org/en/stable/deploying.html">the <code class="docutils literal notranslate"><span class="pre">dask</span></code>
docs</a>).</p>
<figure class="align-center">
<a class="reference internal image-reference" href="https://docs.dask.org/en/stable/_images/dask-cluster-manager.svg"><img alt="https://docs.dask.org/en/stable/_images/dask-cluster-manager.svg" src="https://docs.dask.org/en/stable/_images/dask-cluster-manager.svg" style="width: 80%;" /></a>
</figure>
<section id="overview">
<h4>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">dask</span></code> ecosystem provides <a class="reference external" href="https://distributed.dask.org"><code class="docutils literal notranslate"><span class="pre">dask.distributed</span></code></a> which
lets you spin up a dask cluster on distributed infrastructure.
<a class="reference external" href="https://jobqueue.dask.org"><code class="docutils literal notranslate"><span class="pre">dask_jobqueue</span></code></a> supports doing this on HPC machines.</p>
<p>With these tools, you have fine-grained control over how many batch jobs you
start. This is useful for cases where you have many small workloads (each
<code class="docutils literal notranslate"><span class="pre">func(pset)</span></code> runs only a few seconds, say). Then one batch job per <code class="docutils literal notranslate"><span class="pre">pset</span></code>, as
in the <a class="reference internal" href="#s-templates"><span class="std std-ref">templates workflow</span></a>, would
be overhead and using many dask workers living in only a few (or one!) batch
job is more efficient.</p>
<p>From the <code class="docutils literal notranslate"><span class="pre">psweep</span></code> side of things, you just need to provide a <code class="docutils literal notranslate"><span class="pre">dask</span></code> client (see
below) and that’s it. The challenge is to determine how to distribute the work
and to define a matching <code class="docutils literal notranslate"><span class="pre">dask</span></code> client, which depends entirely on the type of
workload and the compute infrastructure you wish to run on.</p>
<p>See <code class="docutils literal notranslate"><span class="pre">examples/batch_dask/slurm_cluster_settings.py</span></code> for a detailed example
which covers the most important <code class="docutils literal notranslate"><span class="pre">SLURMCluster</span></code> settings.</p>
</section>
<section id="api">
<h4>API<a class="headerlink" href="#api" title="Link to this heading">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">psweep</span></code> API to use <code class="docutils literal notranslate"><span class="pre">dask</span></code> is <code class="docutils literal notranslate"><span class="pre">df=ps.run(...,</span> <span class="pre">dask_client=client)</span></code>.
First, let’s look at an example for using <code class="docutils literal notranslate"><span class="pre">dask</span></code> locally.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">LocalCluster</span>

<span class="c1"># The type of cluster depends on your compute infastructure. Replace</span>
<span class="c1"># LocalCluster with e.g. dask_jobqueue.SLURMCluster when running on a HPC</span>
<span class="c1"># machine.</span>
<span class="n">cluster</span> <span class="o">=</span> <span class="n">LocalCluster</span><span class="p">()</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>

<span class="c1"># The same as always, only pass dask_client in addition</span>
<span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">dask_client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">LocalCluster</span></code> uses all cores by default, which has the same effect as using</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">cpu_count</span>

<span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">poolsize</span><span class="o">=</span><span class="n">cpu_count</span><span class="p">())</span>
</pre></div>
</div>
<p>but using <code class="docutils literal notranslate"><span class="pre">dask</span></code> instead of <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code>.</p>
<p>If you run on a chunky workstation with many cores instead of a full-on HPC
machine, you may still want to use <code class="docutils literal notranslate"><span class="pre">dask</span></code> + <code class="docutils literal notranslate"><span class="pre">LocalCluster</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> since then you can access <code class="docutils literal notranslate"><span class="pre">dask</span></code>’s dashboard (see below).
Also check <a class="reference external" href="https://www.youtube.com/watch?v=N_GqzcuGLCY">this tutorial</a> and
others by Matthew Rocklin.</p>
<p>Note: <code class="docutils literal notranslate"><span class="pre">LocalCluster</span></code> is actually default, so</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
</pre></div>
</div>
<p>is sufficient for running locally.</p>
</section>
<section id="hpc-machine-example">
<h4>HPC machine example<a class="headerlink" href="#hpc-machine-example" title="Link to this heading">#</a></h4>
<p>The example below uses the SLURM workload manager typically found in HPC
centers.</p>
<p>Create a script that</p>
<ul class="simple">
<li><p>spins up a dask cluster on your (HPC) infrastructure (<code class="docutils literal notranslate"><span class="pre">SLURMCluster</span></code>), this
is the only additional step compared to running locally</p></li>
<li><p>defines parameters to sweep over, runs workloads and collects results in a
database (<code class="docutils literal notranslate"><span class="pre">ps.pgrid(...)</span></code>, <code class="docutils literal notranslate"><span class="pre">ps.run(...)</span></code>)</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">run_psweep.py</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Start a dask cluster running on HPC infrastructure via SLURMCluster. Run</span>
<span class="sd">workloads via ps.run() and collect results. The only difference to a local run</span>
<span class="sd">is using ps.run(..., dask_client=client).</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">dask_jobqueue</span> <span class="kn">import</span> <span class="n">SLURMCluster</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">psweep</span> <span class="k">as</span> <span class="nn">ps</span>


<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">pset</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="n">pset</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Settings in SLURMCluster() apply to one batch job, started with e.g.</span>
    <span class="c1"># cluster.scale(jobs=1).</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="n">SLURMCluster</span><span class="p">(</span>
        <span class="n">queue</span><span class="o">=</span><span class="s2">&quot;some_queue,some_other_queue&quot;</span><span class="p">,</span>
        <span class="c1">##account=&quot;some_account&quot;,</span>
        <span class="n">processes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">cores</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">memory</span><span class="o">=</span><span class="s2">&quot;10GiB&quot;</span><span class="p">,</span>
        <span class="n">walltime</span><span class="o">=</span><span class="s2">&quot;00:10:00&quot;</span><span class="p">,</span>
        <span class="n">local_directory</span><span class="o">=</span><span class="s2">&quot;dask_tmp&quot;</span><span class="p">,</span>
        <span class="n">log_directory</span><span class="o">=</span><span class="s2">&quot;dask_log&quot;</span><span class="p">,</span>
        <span class="n">scheduler_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;dashboard_address&quot;</span><span class="p">:</span> <span class="s2">&quot;:3333&quot;</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">dashboard_link</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">job_script</span><span class="p">())</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">plist</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>

    <span class="c1"># Start 2 batch jobs (cluster.scale(jobs=2)), each with 10 dask workers</span>
    <span class="c1"># (processes=10) and 10 cores (cores=10), so 1 core (1 thread) / worker and</span>
    <span class="c1"># 20 workers in total (2 jobs x 10 workers). Each worker gets 1 GiB of</span>
    <span class="c1"># memory (memory=&quot;10GiB&quot; for 10 workers per batch job). See</span>
    <span class="c1"># examples/batch_dask/slurm_cluster_settings.py .</span>
    <span class="n">cluster</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">jobs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">dask_client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>

    <span class="n">ps</span><span class="o">.</span><span class="n">df_print</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;_pset_id&quot;</span><span class="p">,</span> <span class="s2">&quot;_exec_host&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>To start calculations</p>
<ul class="simple">
<li><p>run <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">run_psweep.py</span></code> directly from the HPC cluster head
node (if the cluster is yours and/or there is not runtime quota on the head
node) or better yet</p></li>
<li><p>create a SLURM job script, say <code class="docutils literal notranslate"><span class="pre">dask_control.slurm</span></code>, that starts a dask
control process, in our case this is <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">run_psweep.py</span></code>, run <code class="docutils literal notranslate"><span class="pre">sbatch</span> <span class="pre">dask_control.slurm</span></code>, make sure that this job has large time limit; see example
below (recommended)</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">dask_control.slurm</span></code></p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>

<span class="c1">#SBATCH --job-name=dask_control</span>
<span class="c1">#SBATCH -o log_dask_control-%j.log</span>
<span class="c1">#SBATCH -p some_queue,some_other_queue</span>
<span class="c1">#SBATCH --account=some_account</span>
<span class="c1">#SBATCH --ntasks=1</span>
<span class="c1">#SBATCH --cpus-per-task=2</span>
<span class="c1">#SBATCH --time=2-0</span>

<span class="c1"># Submit this job manually via &quot;sbatch &lt;this_script&gt;&quot;. It will run on some node</span>
<span class="c1"># and from there submit the batch jobs to spin up the dask cluster defined in</span>
<span class="c1"># run_psweep.py. The dask cluster will then run workloads. After all work is</span>
<span class="c1"># done, the dask cluster will be teared down and this job will exit.</span>
<span class="c1">#</span>
<span class="c1"># The reason for using a batch job to run the dask control process (so python</span>
<span class="c1"># run_psweep.py) is that typically on HPC machines, there is a time limit for</span>
<span class="c1"># user processes started on the head / login nodes. Therefore the dask control</span>
<span class="c1"># process may get killed before the dask workers have finished processing.</span>

module<span class="w"> </span>load<span class="w"> </span>python

python<span class="w"> </span>run_psweep.py
</pre></div>
</div>
<p>After submitting the job, the SLURM <code class="docutils literal notranslate"><span class="pre">squeue</span></code> output could look like this:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>hpc$<span class="w"> </span>sbatch<span class="w"> </span>dask_control.slurm
hpc$<span class="w"> </span>squeue<span class="w"> </span>-l<span class="w"> </span>-u<span class="w"> </span><span class="nv">$USER</span><span class="w"> </span>-O<span class="w"> </span>JobID,Name,NumNodes,NumTasks,NumCPUs,TimeLimit,State,ReasonList

JOBID<span class="w">     </span>NAME<span class="w">         </span>NODES<span class="w">  </span>TASKS<span class="w">  </span>CPUS<span class="w">  </span>TIME_LIMIT<span class="w">  </span>STATE<span class="w">    </span>NODELIST<span class="o">(</span>REASON<span class="o">)</span>
<span class="m">6278655</span><span class="w">   </span>dask_control<span class="w"> </span><span class="m">1</span><span class="w">      </span><span class="m">1</span><span class="w">      </span><span class="m">2</span><span class="w">     </span><span class="m">2</span>-00:00:00<span class="w">  </span>RUNNING<span class="w">  </span>node042
<span class="m">6278656</span><span class="w">   </span>dask-worker<span class="w">  </span><span class="m">1</span><span class="w">      </span><span class="m">1</span><span class="w">      </span><span class="m">10</span><span class="w">    </span><span class="m">10</span>:00<span class="w">       </span>RUNNING<span class="w">  </span>node123
<span class="m">6278657</span><span class="w">   </span>dask-worker<span class="w">  </span><span class="m">1</span><span class="w">      </span><span class="m">1</span><span class="w">      </span><span class="m">10</span><span class="w">    </span><span class="m">10</span>:00<span class="w">       </span>RUNNING<span class="w">  </span>node124
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">dask_control</span></code> process runs on <code class="docutils literal notranslate"><span class="pre">node042</span></code> while the two jobs that hold
the dask cluster with 10 dask workers each run <code class="docutils literal notranslate"><span class="pre">node123</span></code> and <code class="docutils literal notranslate"><span class="pre">node124</span></code>.</p>
</section>
<section id="access-to-the-dask-dashboard">
<h4>Access to the <code class="docutils literal notranslate"><span class="pre">dask</span></code> dashboard<a class="headerlink" href="#access-to-the-dask-dashboard" title="Link to this heading">#</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">dask</span></code> has a <a class="reference external" href="https://docs.dask.org/en/stable/dashboard.html">nice dashboard</a>
to visualize the state of all workers. Say you set the dashboard port to 3333
in <code class="docutils literal notranslate"><span class="pre">SLURMCluster</span></code>. If the <code class="docutils literal notranslate"><span class="pre">dask_control</span></code> process runs on the head node, you
only need to forward that port to your local machine (<code class="docutils literal notranslate"><span class="pre">mybox</span></code>):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mybox$<span class="w"> </span>ssh<span class="w"> </span>-L<span class="w"> </span><span class="m">2222</span>:localhost:3333<span class="w"> </span>hpc.machine.edu
mybox$<span class="w"> </span>browser<span class="w"> </span>localhost:2222
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">dask_control</span></code> runs on a compute node, you will need a second tunnel:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mybox$<span class="w"> </span>ssh<span class="w"> </span>-L<span class="w"> </span><span class="m">2222</span>:localhost:3333<span class="w"> </span>hpc.machine.edu
hpc$<span class="w"> </span>ssh<span class="w"> </span>-L<span class="w"> </span><span class="m">3333</span>:localhost:3333<span class="w"> </span>node42
mybox$<span class="w"> </span>browser<span class="w"> </span>localhost:2222
</pre></div>
</div>
</section>
<section id="jupyter">
<h4>Jupyter<a class="headerlink" href="#jupyter" title="Link to this heading">#</a></h4>
<p>Many HPC centers offer a <a class="reference external" href="https://jupyter.org/hub">JupyterHub</a> service, where a
small batch job is started that runs a JupyterLab. When using that, you can
skip the <code class="docutils literal notranslate"><span class="pre">dask_control</span></code> batch job part and run the content of <code class="docutils literal notranslate"><span class="pre">run_psweep.py</span></code>
in Jupyter. JupyterLab also has <a class="reference external" href="https://github.com/dask/dask-labextension">an
extension</a> that gives you access to
the dask dashboard and more.</p>
</section>
<section id="how-to-request-gpus">
<h4>How to request GPUs<a class="headerlink" href="#how-to-request-gpus" title="Link to this heading">#</a></h4>
<p>See <code class="docutils literal notranslate"><span class="pre">examples/batch_dask/run_psweep_jax_gpu.py</span></code>.</p>
</section>
<section id="pros-and-cons">
<h4>Pros and Cons<a class="headerlink" href="#pros-and-cons" title="Link to this heading">#</a></h4>
<div class="hint admonition">
<p class="admonition-title">Pros</p>
<ul class="simple">
<li><p>Simple API, same workflow as if running locally.</p></li>
<li><p>Fine-grained control over mapping of workloads to compute resources.</p></li>
<li><p>You can run on all the different compute infrastructures that
<code class="docutils literal notranslate"><span class="pre">dask.distributed</span></code> (+ <code class="docutils literal notranslate"><span class="pre">dask_jobqueue</span></code>) support, such as Kubernetes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dask</span></code>’s JupyterLab integration.</p></li>
</ul>
</div>
<div class="attention admonition">
<p class="admonition-title">Cons</p>
<ul class="simple">
<li><p>Assigning different resources (GPUs or not, large or small memory) to different
dask workers is hard or even not possible with <code class="docutils literal notranslate"><span class="pre">dask_jobqueue</span></code> since the
design assumes that you create one <code class="docutils literal notranslate"><span class="pre">FooCluster</span></code> with fixed resource
specifications. See these discussions for more:
<a class="github reference external" href="https://github.com/dask/dask-jobqueue/issues/378">dask/dask-jobqueue#378</a>
<a class="github reference external" href="https://github.com/dask/dask-jobqueue/issues/378">dask/dask-jobqueue#378</a>.</p></li>
<li><p>HPC cluster time limits might be a problem if some jobs are waiting in the
queue for a long time and meanwhile the <code class="docutils literal notranslate"><span class="pre">dask_control</span></code> batch job gets
terminated due to its time limit. The latter should be set to the longest
available on the system, e.g. if you have a queue for long-running jobs, use
that. Also the batch jobs holding workers have a time limit. See <a class="reference external" href="https://jobqueue.dask.org/en/latest/clusters-advanced-tips-and-tricks.html#how-to-handle-job-queueing-system-walltime-killing-workers">this part
of the <code class="docutils literal notranslate"><span class="pre">dask_jobqueue</span></code>
docs</a>
for how to handle the latter and <a class="reference external" href="https://github.com/elcorto/psweep/issues/11#issuecomment-1757564391">this
comment</a>
for more.</p></li>
<li><p>More software to install: On the HPC machine, you need <code class="docutils literal notranslate"><span class="pre">psweep</span></code>,
<code class="docutils literal notranslate"><span class="pre">dask.distributed</span></code> and <code class="docutils literal notranslate"><span class="pre">dask_jobqueue</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dask</span></code> uses <a class="reference external" href="https://github.com/cloudpipe/cloudpickle"><code class="docutils literal notranslate"><span class="pre">cloudpickle</span></code></a> to
serialize data before sending it to workers, which may fail in some cases
such as data generated by
<a class="reference external" href="https://pytorch.org/docs/stable/generated/torch.compile.html"><code class="docutils literal notranslate"><span class="pre">torch.compile</span></code></a></p></li>
</ul>
</div>
</section>
</section>
<section id="templates">
<span id="s-templates"></span><h3>Templates<a class="headerlink" href="#templates" title="Link to this heading">#</a></h3>
<p>This template-based workflow is basically a modernized
and stripped-down version of
<a class="reference external" href="https://elcorto.github.io/pwtools/written/background/param_study.html"><code class="docutils literal notranslate"><span class="pre">pwtools.batch</span></code></a>.
Note that we don’t use any method like DRMAA to automatically dispatch jobs to
clusters. Instead we write out a shell script to submit jobs. The design
revolves around maximal user control of each step of the workflow.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This workflow, while being the most general, might not be ideal for all
workloads. See the <a class="reference internal" href="#s-template-pro-con"><span class="std std-ref">Pros and Cons</span></a> section below.</p>
</div>
<p>The central function to use is <code class="docutils literal notranslate"><span class="pre">ps.prep_batch()</span></code>. See <code class="docutils literal notranslate"><span class="pre">examples/batch_templates</span></code>
for a full example.</p>
<p>The workflow is based on <strong>template files</strong>. In the templates, we use the
standard library’s
<a class="reference external" href="https://docs.python.org/3/library/string.html#template-strings"><code class="docutils literal notranslate"><span class="pre">string.Template</span></code></a>,
where each <code class="docutils literal notranslate"><span class="pre">$foo</span></code> is replaced by a value contained in a pset, so <code class="docutils literal notranslate"><span class="pre">$param_a</span></code>,
<code class="docutils literal notranslate"><span class="pre">$param_b</span></code>, as well as <code class="docutils literal notranslate"><span class="pre">$_pset_id</span></code> and so forth.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If your template files are shell scripts that contain variables like <code class="docutils literal notranslate"><span class="pre">$foo</span></code>,
you need to escape the <code class="docutils literal notranslate"><span class="pre">$</span></code> with <code class="docutils literal notranslate"><span class="pre">$$foo</span></code>, else they will be treated as
placeholders.</p>
</div>
<p>We piggy-back on the <code class="docutils literal notranslate"><span class="pre">run()</span></code> workflow from above to, instead of running jobs
with it, just <strong>create batch scripts using template files</strong>.</p>
<p>You can use the proposed workflow below directly on the remote machine (need to
install <code class="docutils literal notranslate"><span class="pre">psweep</span></code> there) or run it locally and use a copy-to-cluster workflow.
Since we actually don’t start jobs or talk to the batch system, you have full
control over every part of the workflow. We just automate the boring stuff.</p>
<section id="workflow-summary">
<h4>Workflow summary<a class="headerlink" href="#workflow-summary" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>define <code class="docutils literal notranslate"><span class="pre">params</span></code> to be varied as shown above (probably in a script, say
<code class="docutils literal notranslate"><span class="pre">input.py</span></code>)</p></li>
<li><p>in that script, call <code class="docutils literal notranslate"><span class="pre">ps.prep_batch(params)</span></code> (instead of <code class="docutils literal notranslate"><span class="pre">run(...,</span> <span class="pre">params)</span></code>);
this performs these steps for you</p>
<ul>
<li><p>use <code class="docutils literal notranslate"><span class="pre">templates/calc/*</span></code>: scripts that you want to run in each batch job</p></li>
<li><p>use <code class="docutils literal notranslate"><span class="pre">templates/machines/&lt;mycluster&gt;/jobscript</span></code>: batch job script</p></li>
<li><p>read <code class="docutils literal notranslate"><span class="pre">templates/machines/&lt;mycluster&gt;/info.yaml</span></code>: machine-specific info
(e.g. command to submit the <code class="docutils literal notranslate"><span class="pre">jobscript</span></code>)</p></li>
<li><p>define <code class="docutils literal notranslate"><span class="pre">func()</span></code> that will create a dir named <code class="docutils literal notranslate"><span class="pre">calc/&lt;pset_id&gt;</span></code> for each
batch job, <strong>replace placeholders</strong> such as <code class="docutils literal notranslate"><span class="pre">$param_a</span></code> from <code class="docutils literal notranslate"><span class="pre">pset</span></code>s
(including special ones such as <code class="docutils literal notranslate"><span class="pre">$_pset_id</span></code>)</p></li>
<li><p>call <code class="docutils literal notranslate"><span class="pre">run(func,</span> <span class="pre">params)</span></code></p></li>
<li><p>create a script <code class="docutils literal notranslate"><span class="pre">calc/run_&lt;mycluster&gt;.sh</span></code> to submit all jobs</p></li>
</ul>
</li>
<li><p>if running locally</p>
<ul>
<li><p>use <code class="docutils literal notranslate"><span class="pre">scp</span></code> or <code class="docutils literal notranslate"><span class="pre">rsync</span></code> or the helper script <code class="docutils literal notranslate"><span class="pre">bin/psweep-push</span> <span class="pre">&lt;mycluster&gt;</span></code> (uses
<code class="docutils literal notranslate"><span class="pre">rsync</span></code>) to copy <code class="docutils literal notranslate"><span class="pre">calc/</span></code> to a cluster</p></li>
</ul>
</li>
<li><p>ssh to cluster</p></li>
<li><p>execute <code class="docutils literal notranslate"><span class="pre">calc/run_&lt;mycluster&gt;.sh</span></code>, wait …</p></li>
<li><p>if running locally</p>
<ul>
<li><p>use <code class="docutils literal notranslate"><span class="pre">scp</span></code> or <code class="docutils literal notranslate"><span class="pre">rsync</span></code> or the helper script use <code class="docutils literal notranslate"><span class="pre">bin/psweep-pull</span> <span class="pre">&lt;mycluster&gt;</span></code>
(uses <code class="docutils literal notranslate"><span class="pre">rsync</span></code>) to copy results back</p></li>
</ul>
</li>
</ul>
<p>Now suppose that each of our batch jobs produces an output file, then we have
the same post-processing setup as in <code class="docutils literal notranslate"><span class="pre">save_data_on_disk</span></code>, namely</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>calc
├── 63b5daae-1b37-47e9-a11c-463fb4934d14
│   └── output.txt
├── 657cb9f9-8720-4d4c-8ff1-d7ddc7897700
│   └── output.txt
├── d7849792-622d-4479-aec6-329ed8bedd9b
│   └── output.txt
├── de8ac159-b5d0-4df6-9e4b-22ebf78bf9b0
│   └── output.txt
└── database.pk
</pre></div>
</div>
<p>Post-processing is (almost) as before:</p>
<ul class="simple">
<li><p>analyze results, run post-processing script(s) on <code class="docutils literal notranslate"><span class="pre">calc/database.pk</span></code>, read in
<code class="docutils literal notranslate"><span class="pre">output.txt</span></code> for each <code class="docutils literal notranslate"><span class="pre">_pset_id</span></code></p></li>
<li><p>when extending the study (modify <code class="docutils literal notranslate"><span class="pre">params</span></code>, call <code class="docutils literal notranslate"><span class="pre">input.py</span></code> again which calls
<code class="docutils literal notranslate"><span class="pre">prep_batch(params)</span></code>), we use the same features shown above</p>
<ul>
<li><p>append to database</p></li>
<li><p>create new unique <code class="docutils literal notranslate"><span class="pre">calc/&lt;pset_id&gt;</span></code> without overwriting anything</p></li>
<li><p><strong>additionally</strong>: write a new <code class="docutils literal notranslate"><span class="pre">calc/run_&lt;mycluster&gt;.sh</span></code> with old submit
commands still in there, but commented out</p></li>
</ul>
</li>
</ul>
</section>
<section id="templates-layout-and-written-files">
<h4>Templates layout and written files<a class="headerlink" href="#templates-layout-and-written-files" title="Link to this heading">#</a></h4>
<p>An example template dir, based on <code class="docutils literal notranslate"><span class="pre">examples/batch_templates</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>templates
├── calc
│   └── run.py
└── machines
    ├── cluster
    │   ├── info.yaml
    │   └── jobscript
    └── local
        ├── info.yaml
        └── jobscript
</pre></div>
</div>
<p>The template workflow is very generic. One aspect of this design is that each
template file is treated as a simple text file, be it a Python script, a shell
script, a config file or anything else. Above we use a small Python script
<code class="docutils literal notranslate"><span class="pre">run.py</span></code> for demonstration purposes and communicate <code class="docutils literal notranslate"><span class="pre">pset</span></code> content (parameters
to vary) by replacing placeholders in there. See <a class="reference internal" href="#s-template-pro-con"><span class="std std-ref">this
section</span></a> for other ways to improve this in the Python
script case.</p>
<section id="calc-templates">
<h5>calc templates<a class="headerlink" href="#calc-templates" title="Link to this heading">#</a></h5>
<p>Each file in <code class="docutils literal notranslate"><span class="pre">templates/calc</span></code> such as <code class="docutils literal notranslate"><span class="pre">run.py</span></code> will be treated as
template, goes thru the file template machinery and ends up in
<code class="docutils literal notranslate"><span class="pre">calc/&lt;pset_id&gt;/</span></code>.</p>
</section>
<section id="machine-templates">
<h5>machine templates<a class="headerlink" href="#machine-templates" title="Link to this heading">#</a></h5>
<p>The example above has machine templates for 2 machines, “local” and a
remote machine named “cluster”. <code class="docutils literal notranslate"><span class="pre">psweep</span></code> will generate <code class="docutils literal notranslate"><span class="pre">run_&lt;machine&gt;.sh</span></code>
for both. Also you must provide a file <code class="docutils literal notranslate"><span class="pre">info.yaml</span></code> to store
machine-specific info. ATM this is only <code class="docutils literal notranslate"><span class="pre">subcmd</span></code>, e.g.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># templates/machines/cluster/info.yaml</span>
<span class="nn">---</span>
<span class="nt">subcmd</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sbatch</span>
</pre></div>
</div>
<p>All other SLURM stuff can go into <code class="docutils literal notranslate"><span class="pre">templates/machines/cluster/jobscript</span></code>, e.g.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1">#SBATCH --time 00:20:00</span>
<span class="c1">#SBATCH -o out.log</span>
<span class="c1">#SBATCH -J foo_${_pset_seq}_${_pset_id}</span>
<span class="c1">#SBATCH -p bar</span>
<span class="c1">#SBATCH -A baz</span>

<span class="c1"># Because we use Python&#39;s string.Template, we need to escape the dollar char</span>
<span class="c1"># with two.</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;hostname=</span><span class="nv">$$</span><span class="s2">(hostname)&quot;</span>

module<span class="w"> </span>purge

module<span class="w"> </span>load<span class="w"> </span>bzzrrr/1.2.3
module<span class="w"> </span>load<span class="w"> </span>python

python3<span class="w"> </span>run.py
</pre></div>
</div>
<p>For the “local” machine we’d just use <code class="docutils literal notranslate"><span class="pre">sh</span></code> (or <code class="docutils literal notranslate"><span class="pre">bash</span></code> or …) as “submit
command”.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># templates/machines/local/info.yaml</span>
<span class="nn">---</span>
<span class="nt">subcmd</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sh</span>
</pre></div>
</div>
<p>The files written are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>run_cluster.sh                              # submit script for each machine
run_local.sh

calc/3c4efcb7-e37e-4ffe-800d-b05db171b41b   # one dir per pset
├── jobscript_cluster                       # jobscript for each machine
├── jobscript_local
└── run.py                                  # from templates/calc/run.py
calc/11967c0d-7ce6-404f-aae6-2b0ea74beefa
├── jobscript_cluster
├── jobscript_local
└── run.py
calc/65b7b453-96ec-4694-a0c4-4f71c53d982a
...
</pre></div>
</div>
<p>In each <code class="docutils literal notranslate"><span class="pre">run_&lt;machine&gt;.sh</span></code> we use the <code class="docutils literal notranslate"><span class="pre">subcmd</span></code> from <code class="docutils literal notranslate"><span class="pre">info.yaml</span></code>.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="nv">here</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>
<span class="nb">cd</span><span class="w"> </span>3c4efcb7-e37e-4ffe-800d-b05db171b41b<span class="p">;</span><span class="w"> </span>sbatch<span class="w"> </span>jobscript_cluster<span class="p">;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$here</span><span class="w">  </span><span class="c1"># run_seq=0 pset_seq=0</span>
<span class="nb">cd</span><span class="w"> </span>11967c0d-7ce6-404f-aae6-2b0ea74beefa<span class="p">;</span><span class="w"> </span>sbatch<span class="w"> </span>jobscript_cluster<span class="p">;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$here</span><span class="w">  </span><span class="c1"># run_seq=0 pset_seq=1</span>
...
</pre></div>
</div>
</section>
</section>
<section id="git-support">
<h4>git support<a class="headerlink" href="#git-support" title="Link to this heading">#</a></h4>
<p>Use <code class="docutils literal notranslate"><span class="pre">prep_batch(...,</span> <span class="pre">git=True)</span></code> to have some basic git support such as
automatic commits in each call. It uses <code class="docutils literal notranslate"><span class="pre">run(...,</span> <span class="pre">git=True)</span></code> when
creating batch scripts, so all best practices for that apply here as well. In
particular, make sure to create <code class="docutils literal notranslate"><span class="pre">.gitignore</span></code> first, else we’ll track <code class="docutils literal notranslate"><span class="pre">calc/</span></code> as
well, which you may safely do when data in <code class="docutils literal notranslate"><span class="pre">calc</span></code> is small. Else use <code class="docutils literal notranslate"><span class="pre">git-lfs</span></code>,
for example.</p>
</section>
<section id="s-template-pro-con">
<span id="id1"></span><h4>Pros and Cons<a class="headerlink" href="#s-template-pro-con" title="Link to this heading">#</a></h4>
<div class="hint admonition">
<p class="admonition-title">Pros</p>
<ul class="simple">
<li><p>Works for all workloads, also ones with no Python interface; for instance you
can sweep over SLURM settings easily (number of cores, memory, GPU yes or
no, …).</p></li>
<li><p>No <code class="docutils literal notranslate"><span class="pre">dask_control</span></code> process. Once you submitt jobs and assuming that each job
has a time limit that is large enough, jobs may wait in the queue for days.
The workflow leverages the more non-interactive nature of HPC systems.
You can once in a while run a post-processing script and collect
results that are already written (e.g. <code class="docutils literal notranslate"><span class="pre">&lt;calc_dir&gt;/&lt;pset_id&gt;/result.pk</span></code>) and
start to analyse this (partial) data.</p></li>
<li><p>Uses only batch system tooling, so essentially shell scripts. If you copy
(<code class="docutils literal notranslate"><span class="pre">rsync</span></code>!) generated files to and from the HPC machine, you don’t even need to
install <code class="docutils literal notranslate"><span class="pre">psweep</span></code> there.</p></li>
</ul>
</div>
<div class="attention admonition">
<p class="admonition-title">Cons</p>
<ul class="simple">
<li><p>More manual multi-step workflow comparted to local and <code class="docutils literal notranslate"><span class="pre">dask</span></code> where we can
just do <code class="docutils literal notranslate"><span class="pre">df=ps.run(...)</span></code> and have results in <code class="docutils literal notranslate"><span class="pre">df</span></code>.</p></li>
<li><p>Always one batch job per <code class="docutils literal notranslate"><span class="pre">pset</span></code>.</p></li>
<li><p>The workflow is suited for more experienced HPC users. You may need to work
a bit more directly with your batch system (<code class="docutils literal notranslate"><span class="pre">squeue</span></code>, <code class="docutils literal notranslate"><span class="pre">scancel</span></code>, … in case
of SLURM). Also some shell scripting skills are useful.</p></li>
</ul>
<p>More details, tips and tricks below.</p>
</div>
<p>The template workflow will create one batch job per <code class="docutils literal notranslate"><span class="pre">pset</span></code>. If the workload in
<code class="docutils literal notranslate"><span class="pre">run.py</span></code> is small, then this creates some overhead. Use this only if you have
sizable workloads. For many small lightweight workloads, better start one batch
job manually (ideally on a node with many cores), replace <code class="docutils literal notranslate"><span class="pre">run.py</span></code>’s content
with a function <code class="docutils literal notranslate"><span class="pre">func(pset)</span></code> and then use something like <code class="docutils literal notranslate"><span class="pre">ps.run(func,</span> <span class="pre">params,</span> <span class="pre">poolsize=n_cores)</span></code> in that job.</p>
<p>The communication of the <code class="docutils literal notranslate"><span class="pre">pset</span></code> content via filling templates is suited for
non-Python workloads, such as simulation software with text input files and no
Python interface, for instance</p>
<p><code class="docutils literal notranslate"><span class="pre">templates/calc/input_file</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Input file for super fast bzzrrr simulation code.

param_a = $param_a
param_b = $param_b
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">templates/machines/cluster/jobscript</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1">#SBATCH --time 00:20:00</span>
<span class="c1">#SBATCH -o out.log</span>
<span class="c1">#SBATCH -J foo_${_pset_seq}_${_pset_id}</span>
<span class="c1">#SBATCH -p bar</span>
<span class="c1">#SBATCH -A baz</span>
<span class="c1">#SBATCH -n 1 -c 8</span>

module<span class="w"> </span>purge
module<span class="w"> </span>load<span class="w"> </span>bzzrrr/1.2.3

mpirun<span class="w"> </span>-np<span class="w"> </span><span class="m">8</span><span class="w"> </span>bzzrrr<span class="w"> </span>input_file
</pre></div>
</div>
<p>For Python workloads (the one we have in
<code class="docutils literal notranslate"><span class="pre">examples/batch_templates/templates/calc/run.py</span></code>), using placeholders like
<code class="docutils literal notranslate"><span class="pre">$param_a</span></code> is actually a bit of an anti-pattern, since we would ideally like to
pass the <code class="docutils literal notranslate"><span class="pre">pset</span></code> to the workload using Python. With templates, we can use
<code class="docutils literal notranslate"><span class="pre">prep_batch(...,</span> <span class="pre">write_pset=True)</span></code> which writes
<code class="docutils literal notranslate"><span class="pre">&lt;calc_dir&gt;/&lt;pset_id&gt;/pset.pk</span></code>. In <code class="docutils literal notranslate"><span class="pre">run.py</span></code> you can then do</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">psweep</span> <span class="k">as</span> <span class="nn">ps</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">pset</span><span class="p">):</span>
    <span class="o">...</span> <span class="n">here</span> <span class="n">be</span> <span class="n">code</span> <span class="o">...</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># Even better (less code):</span>
<span class="c1">##from my_utils_module import func</span>

<span class="c1"># write &lt;calc_dir&gt;/&lt;pset_id&gt;/result.pk</span>
<span class="n">ps</span><span class="o">.</span><span class="n">pickle_write</span><span class="p">(</span><span class="s2">&quot;result.pk&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="n">ps</span><span class="o">.</span><span class="n">pickle_read</span><span class="p">(</span><span class="s2">&quot;pset.pk&quot;</span><span class="p">)))</span>
</pre></div>
</div>
<p>Note that from all the <code class="docutils literal notranslate"><span class="pre">&lt;calc_dir&gt;/&lt;pset_id&gt;/result.pk</span></code> files, you can actually
reconstruct a <code class="docutils literal notranslate"><span class="pre">database_eval.pk</span></code> since each <code class="docutils literal notranslate"><span class="pre">result.pk</span></code> is a dict with results,
so a row in the DataFrame.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">df_input</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">df_read</span><span class="p">(</span><span class="s2">&quot;calc/database.pk&quot;</span><span class="p">)</span>

<span class="n">dicts</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ps</span><span class="o">.</span><span class="n">pickle_read</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;calc/</span><span class="si">{</span><span class="n">pset_id</span><span class="si">}</span><span class="s2">/result.pk&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">pset_id</span> <span class="ow">in</span>
    <span class="n">df_input</span><span class="o">.</span><span class="n">_pset_id</span><span class="o">.</span><span class="n">values</span>
    <span class="p">]</span>

<span class="n">df_eval</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dicts</span><span class="p">)</span>
<span class="n">ps</span><span class="o">.</span><span class="n">df_write</span><span class="p">(</span><span class="s2">&quot;db/database_eval.pk&quot;</span><span class="p">,</span> <span class="n">df_eval</span><span class="p">)</span>
</pre></div>
</div>
<p>This is not ideal since we communicate by writing (potentially
many) small files, namely <code class="docutils literal notranslate"><span class="pre">run.py</span></code>, <code class="docutils literal notranslate"><span class="pre">pset.pk</span></code>, <code class="docutils literal notranslate"><span class="pre">result.pk</span></code>
<code class="docutils literal notranslate"><span class="pre">jobscript_&lt;cluster&gt;</span></code> for each <code class="docutils literal notranslate"><span class="pre">&lt;calc_dir&gt;/&lt;pset_id&gt;/</span></code> dir. Also, in the
example above, <code class="docutils literal notranslate"><span class="pre">run.py</span></code> would be the exact same file for each job.</p>
<p>So we recommend to use the <code class="docutils literal notranslate"><span class="pre">dask</span></code> workflow if you can and use templates as a
fallback solution, for instance if <code class="docutils literal notranslate"><span class="pre">dask_jobqueue</span></code> doesn’t have
something that matches your compute infrastructure.</p>
</section>
</section>
</section>
<section id="special-topics">
<h2>Special topics<a class="headerlink" href="#special-topics" title="Link to this heading">#</a></h2>
<section id="how-to-migrate-a-normal-git-repo-to-git-lfs">
<h3>How to migrate a normal <code class="docutils literal notranslate"><span class="pre">git</span></code> repo to <code class="docutils literal notranslate"><span class="pre">git-lfs</span></code><a class="headerlink" href="#how-to-migrate-a-normal-git-repo-to-git-lfs" title="Link to this heading">#</a></h3>
<p>First we’ll quickly mention how to set up LFS in a <em>new</em> repo. In this case we
just need to configure <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">lfs</span></code> to track certain files. We’ll use dirs
<code class="docutils literal notranslate"><span class="pre">_pics/</span></code> and <code class="docutils literal notranslate"><span class="pre">calc/</span></code> as examples.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>lfs<span class="w"> </span>track<span class="w"> </span><span class="s2">&quot;_pics/**&quot;</span><span class="w"> </span><span class="s2">&quot;calc/**&quot;</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">**</span></code> means recursive. This will write the config to <code class="docutils literal notranslate"><span class="pre">.gitattributes</span></code>.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>.gitattributes
_pics/**<span class="w"> </span><span class="nv">filter</span><span class="o">=</span>lfs<span class="w"> </span><span class="nv">diff</span><span class="o">=</span>lfs<span class="w"> </span><span class="nv">merge</span><span class="o">=</span>lfs<span class="w"> </span>-text
calc/**<span class="w"> </span><span class="nv">filter</span><span class="o">=</span>lfs<span class="w"> </span><span class="nv">diff</span><span class="o">=</span>lfs<span class="w"> </span><span class="nv">merge</span><span class="o">=</span>lfs<span class="w"> </span>-text
</pre></div>
</div>
<p>Please refer to the <a class="reference external" href="https://git-lfs.github.com">git lfs docs</a> for more info.</p>
<p>Note: LFS can be tricky to get right the first time around. We actually
recommend to fork the upstream repo, call that remote something like
<code class="docutils literal notranslate"><span class="pre">lfsremote</span></code> and experiment with that before force-pushing LFS content to
<code class="docutils literal notranslate"><span class="pre">origin</span></code>. Anyhow, let’s continue.</p>
<p>Now we like to migrate an existing git repo to LFS. Here we don’t need to call
<code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">lfs</span> <span class="pre">track</span></code> because we’ll use <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">lfs</span> <span class="pre">migrate</span> <span class="pre">import</span></code> to convert the repo.
We will use the <code class="docutils literal notranslate"><span class="pre">-I/--include=</span></code> option to specify which files we would like to
convert to LFS. Those patterns will end up in <code class="docutils literal notranslate"><span class="pre">.gitattributes</span></code> and the file
will even be created of not present already.</p>
<p>We found that only one <code class="docutils literal notranslate"><span class="pre">-I/--include=</span></code> at a time works, but we can separate
patterns by “,” to include multiple ones.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>lfs<span class="w"> </span>migrate<span class="w"> </span>import<span class="w"> </span>-I<span class="w"> </span><span class="s1">&#39;_pics/**,calc/**&#39;</span><span class="w"> </span>--include-ref<span class="o">=</span>master

$<span class="w"> </span>cat<span class="w"> </span>.gitattributes
_pics/**<span class="w"> </span><span class="nv">filter</span><span class="o">=</span>lfs<span class="w"> </span><span class="nv">diff</span><span class="o">=</span>lfs<span class="w"> </span><span class="nv">merge</span><span class="o">=</span>lfs<span class="w"> </span>-text
calc/**<span class="w"> </span><span class="nv">filter</span><span class="o">=</span>lfs<span class="w"> </span><span class="nv">diff</span><span class="o">=</span>lfs<span class="w"> </span><span class="nv">merge</span><span class="o">=</span>lfs<span class="w"> </span>-text
</pre></div>
</div>
<p>Now after the migrate, all LFS files in the working tree (files on disk) have
been converted from their real content to text stub files.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>_pics/foo.png
version<span class="w"> </span>https://git-lfs.github.com/spec/v1
oid<span class="w"> </span>sha256:de0a80ff0fa13a3e8cf8662c073ce76bfc986b64b3c079072202ecff411188ba
size<span class="w"> </span><span class="m">28339</span>
</pre></div>
</div>
<p>The following will not change that.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>push<span class="w"> </span>lfsremote<span class="w"> </span>master<span class="w"> </span>-f
$<span class="w"> </span>git<span class="w"> </span>lfs<span class="w"> </span>fetch<span class="w"> </span>lfsremote<span class="w"> </span>--all
</pre></div>
</div>
<p>Their real content is however still contained in the <code class="docutils literal notranslate"><span class="pre">.git</span></code> dir. A simple</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>lfs<span class="w"> </span>checkout<span class="w"> </span>.

$<span class="w"> </span>cat<span class="w"> </span>_pics/foo.png
&lt;&lt;binary<span class="w"> </span>foo&gt;&gt;
</pre></div>
</div>
<p>will bring the content back to the working dir.</p>
</section>
</section>
<section id="scope-and-related-projects">
<h2>Scope and related projects<a class="headerlink" href="#scope-and-related-projects" title="Link to this heading">#</a></h2>
<p>This project aims to be agnostic to the field of study. We target problems that
can be formulated as <strong>computational experiments</strong>: “let’s vary X,Y and
analyze the results”.</p>
<p>Unsurprisingly, there is a huge pile of similar tools. This project is super
small and as such of course lacks a lot of features that other packages offer.
We only</p>
<ul class="simple">
<li><p>provide simple helpers to set up the params (<code class="docutils literal notranslate"><span class="pre">plist()</span></code>, <code class="docutils literal notranslate"><span class="pre">pgrid()</span></code>,
<code class="docutils literal notranslate"><span class="pre">stargrid()</span></code>)</p></li>
<li><p>hook into the <code class="docutils literal notranslate"><span class="pre">concurrent.futures</span></code> API (<code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> or <code class="docutils literal notranslate"><span class="pre">dask</span></code>) for
parallel runs</p></li>
<li><p>give you a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> with useful metadata</p></li>
</ul>
<p>Otherwise we stay out of the way. In particular we are not a workflow engine,
a tool that lets you define chains of interdependent tasks (but see <a class="reference internal" href="#s-task-deps"><span class="std std-ref">this
section</span></a>). We just attempt to scratch some particular itches here:</p>
<ul class="simple">
<li><p>simulate runs</p></li>
<li><p>backups</p></li>
<li><p>git support</p></li>
<li><p>simple local database (no db server to set up, no Mongo, etc)</p></li>
<li><p>interactive (Python REPL) and script-driven runs</p></li>
<li><p>local runs, also in parallel</p></li>
<li><p>tooling for remote runs (on HPC and other infrastructure)</p></li>
<li><p>minimal naming conventions, rely on UUIDs</p></li>
<li><p>hash-based database filtering</p></li>
<li><p>no yaml-ish DSLs, just Python please, thank you :)</p></li>
<li><p>no CLIs, just Python please, thank you :)</p></li>
<li><p>no config files, just Python please, thank you :)</p></li>
<li><p>not application specific (e.g. machine learning)</p></li>
</ul>
<p>Here is a small list of related projects that we have looked at so far. We try
to roughly classify each tool, based on its <em>main</em> use case, as best as we can.</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>tool</p></th>
<th class="head"><p>workflow</p></th>
<th class="head"><p>param sweep</p></th>
<th class="head"><p>exp. tracking</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference external" href="https://materialsproject.github.io/fireworks/">https://materialsproject.github.io/fireworks/</a></p></td>
<td><p>*</p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://www.aiida.net/">https://www.aiida.net/</a></p></td>
<td><p>*</p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://luigi.readthedocs.io">https://luigi.readthedocs.io</a></p></td>
<td><p>*</p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://snakemake.readthedocs.io">https://snakemake.readthedocs.io</a></p></td>
<td><p>*</p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-even"><td><p><a class="github reference external" href="https://github.com/eviatarbach/parasweep">eviatarbach/parasweep</a></p></td>
<td><p></p></td>
<td><p>*</p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p><a class="github reference external" href="https://github.com/SmokinCaterpillar/pypet">SmokinCaterpillar/pypet</a></p></td>
<td><p></p></td>
<td><p>*</p></td>
<td><p></p></td>
</tr>
<tr class="row-even"><td><p><a class="github reference external" href="https://github.com/pharmbio/sciluigi">pharmbio/sciluigi</a></p></td>
<td><p>*</p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p><a class="github reference external" href="https://github.com/open-research/sumatra">open-research/sumatra</a></p></td>
<td><p></p></td>
<td><p></p></td>
<td><p>*</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://www.nist.gov/programs-projects/simulation-management-tools">https://www.nist.gov/programs-projects/simulation-management-tools</a></p></td>
<td><p></p></td>
<td><p></p></td>
<td><p>*</p></td>
</tr>
<tr class="row-odd"><td><p><a class="github reference external" href="https://github.com/IDSIA/sacred">IDSIA/sacred</a></p></td>
<td><p></p></td>
<td><p></p></td>
<td><p>*</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://www.wandb.ai/">https://www.wandb.ai/</a></p></td>
<td><p></p></td>
<td><p></p></td>
<td><p>*</p></td>
</tr>
<tr class="row-odd"><td><p><a class="github reference external" href="https://github.com/maiot-io/zenml">maiot-io/zenml</a></p></td>
<td><p>*</p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-even"><td><p><a class="github reference external" href="https://github.com/LLNL/maestrowf">LLNL/maestrowf</a></p></td>
<td><p>*</p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://mlflow.org/">https://mlflow.org/</a></p></td>
<td><p></p></td>
<td><p></p></td>
<td><p>*</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://metaflow.org/">https://metaflow.org/</a></p></td>
<td><p>*</p></td>
<td><p></p></td>
<td><p>*</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://www.nextflow.io/">https://www.nextflow.io/</a></p></td>
<td><p>*</p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://dvc.org/">https://dvc.org/</a></p></td>
<td><p></p></td>
<td><p></p></td>
<td><p>*</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://apps.fz-juelich.de/jsc/jube/jube2/docu/index.html">https://apps.fz-juelich.de/jsc/jube/jube2/docu/index.html</a></p></td>
<td><p></p></td>
<td><p>*</p></td>
<td><p>*</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://www.prefect.io/">https://www.prefect.io/</a></p></td>
<td><p>*</p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://hydra.cc/">https://hydra.cc/</a></p></td>
<td><p>*</p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
</tbody>
</table>
</div>
<p>See also <a class="reference external" href="https://github.com/meirwah/awesome-workflow-engines">this long list of workflow
engines</a> and <a class="reference external" href="https://neptune.ai/blog/mlops-tools-platforms-landscape">this even
longer list of MLOps
tools</a>.</p>
<section id="handling-task-dependencies">
<span id="s-task-deps"></span><h3>Handling task dependencies<a class="headerlink" href="#handling-task-dependencies" title="Link to this heading">#</a></h3>
<p>In <code class="docutils literal notranslate"><span class="pre">psweep</span></code> we assume that workloads are independent and “embarrassingly
parallel” if using <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> or <code class="docutils literal notranslate"><span class="pre">dask</span></code>.</p>
<p>So while <code class="docutils literal notranslate"><span class="pre">psweep</span></code> is not a workflow engine where you can model task
dependencies as DAGs, one way to handle (simple linear) task dependencies is by
running things in order manually, say <code class="docutils literal notranslate"><span class="pre">10prepare.py</span></code>, <code class="docutils literal notranslate"><span class="pre">20production.py</span></code>,
<code class="docutils literal notranslate"><span class="pre">30eval.py</span></code>, where the first two can use <code class="docutils literal notranslate"><span class="pre">psweep</span></code> to compute stuff, update the
database and store intermediate data on disk, which the next script would pick
up. The “workflow” is to run all scripts in order. This is super low tech,
simple, but of course also a bit brittle. For more challenging dependencies and
more reproducibility, look into using one of the workflow frameworks above.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./written"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../root.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">&lt;no title&gt;</p>
      </div>
    </a>
    <a class="right-next"
       href="../generated/api/index.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">API Reference</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-started">Getting started</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#concepts">Concepts</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#naming-of-database-fields">Naming of database fields</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-parameter-grids">Building parameter grids</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-define-default-params">How to define default params</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gotchas">Gotchas</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#pgrid"><code class="docutils literal notranslate"><span class="pre">pgrid</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#zip"><code class="docutils literal notranslate"><span class="pre">zip</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-database">The database</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#special-database-fields-and-repeated-runs">Special database fields and repeated runs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#filter-by-pset-hashes">Filter by <code class="docutils literal notranslate"><span class="pre">pset</span></code> hashes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#more-details-on-naming-database-fields">More details on naming database fields</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#best-practices">Best practices</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#save-data-on-disk-use-uuids">Save data on disk, use UUIDs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#post-processing">Post-processing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iterative-extension-of-a-parameter-study">Iterative extension of a parameter study</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-git">Use git</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-handle-large-files-when-using-git">How to handle large files when using git</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#simulate-dry-run-look-before-you-leap">Simulate / Dry-Run: look before you leap</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-give-runs-names-for-easy-post-processing">Advanced: Give runs names for easy post-processing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-handle-failing-workloads">How to handle failing workloads</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#text-logging-per-pset">Text logging per <code class="docutils literal notranslate"><span class="pre">pset</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-on-hpc-compute-infrastructure">Running on (HPC) compute infrastructure</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dask"><code class="docutils literal notranslate"><span class="pre">dask</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#api">API</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hpc-machine-example">HPC machine example</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#access-to-the-dask-dashboard">Access to the <code class="docutils literal notranslate"><span class="pre">dask</span></code> dashboard</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#jupyter">Jupyter</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-request-gpus">How to request GPUs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#pros-and-cons">Pros and Cons</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#templates">Templates</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#workflow-summary">Workflow summary</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#templates-layout-and-written-files">Templates layout and written files</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#calc-templates">calc templates</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#machine-templates">machine templates</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#git-support">git support</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#s-template-pro-con">Pros and Cons</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#special-topics">Special topics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-migrate-a-normal-git-repo-to-git-lfs">How to migrate a normal <code class="docutils literal notranslate"><span class="pre">git</span></code> repo to <code class="docutils literal notranslate"><span class="pre">git-lfs</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#scope-and-related-projects">Scope and related projects</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-task-dependencies">Handling task dependencies</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Steve Schmerler
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>